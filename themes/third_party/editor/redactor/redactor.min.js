(function(b){function q(a,c){return new q.prototype.init(a,c)}var u=0;"use strict";var t=function(a){this[0]=a.startOffset;this[1]=a.endOffset;this.range=a;return this};t.prototype.equals=function(){return this[0]===this[1]};b.fn.redactor=function(a){var c=[],d=Array.prototype.slice.call(arguments,1);"string"===typeof a?this.each(function(){var e=b.data(this,"redactor");if("undefined"!==typeof e&&b.isFunction(e[a])){var f=e[a].apply(e,d);void 0!==f&&f!==e&&c.push(f)}else return b.error('No such method "'+
a+'" for Redactor')}):this.each(function(){b.data(this,"redactor")||b.data(this,"redactor",q(this,a))});return 0===c.length?this:1===c.length?c[0]:c};b.Redactor=q;b.Redactor.VERSION="9.1.8";b.Redactor.opts={rangy:!1,iframe:!1,fullpage:!1,css:!1,lang:"en",direction:"ltr",placeholder:!1,wym:!1,mobile:!0,cleanup:!0,tidyHtml:!0,pastePlainText:!1,removeEmptyTags:!0,templateVars:!1,xhtml:!1,visual:!0,focus:!1,tabindex:!1,autoresize:!0,minHeight:!1,maxHeight:!1,shortcuts:!0,autosave:!1,autosaveInterval:60,
plugins:!1,linkAnchor:!0,linkEmail:!0,linkProtocol:"http://",linkNofollow:!1,linkSize:50,imageFloatMargin:"10px",imageGetJson:!1,imageUpload:!1,imageUploadParam:"file",fileUpload:!1,fileUploadParam:"file",clipboardUpload:!0,clipboardUploadUrl:!1,dragUpload:!0,dnbImageTypes:["image/png","image/jpeg","image/gif"],s3:!1,uploadFields:!1,observeImages:!0,observeLinks:!0,modalOverlay:!0,tabSpaces:!1,tabFocus:!0,air:!1,airButtons:"formatting | bold italic deleted | unorderedlist orderedlist outdent indent".split(" "),
toolbar:!0,toolbarFixed:!1,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarFixedBox:!1,toolbarExternal:!1,buttonSource:!0,buttonSeparator:'<li class="redactor_separator"></li>',buttonsCustom:{},buttonsAdd:[],buttons:"html | formatting | bold italic deleted | unorderedlist orderedlist outdent indent | image video file table link | alignment | horizontalrule".split(" "),activeButtons:"deleted italic bold underline unorderedlist orderedlist alignleft aligncenter alignright justify table".split(" "),
activeButtonsStates:{b:"bold",strong:"bold",i:"italic",em:"italic",del:"deleted",strike:"deleted",ul:"unorderedlist",ol:"orderedlist",u:"underline",tr:"table",td:"table",table:"table"},activeButtonsAdd:!1,formattingTags:"p blockquote pre h1 h2 h3 h4 h5 h6".split(" "),linebreaks:!1,paragraphy:!0,convertDivs:!0,convertLinks:!0,convertImageLinks:!1,convertVideoLinks:!1,formattingPre:!1,phpTags:!1,allowedTags:!1,deniedTags:"html head link body meta script style applet".split(" "),boldTag:"strong",italicTag:"em",
indentValue:20,buffer:[],rebuffer:[],textareamode:!1,emptyHtml:"<p>&#x200b;</p>",invisibleSpace:"&#x200b;",rBlockTest:/^(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)$/i,alignmentTags:"P H1 H2 H3 H4 H5 H6 DD DL DT DIV TD BLOCKQUOTE OUTPUT FIGCAPTION ADDRESS SECTION HEADER FOOTER ASIDE ARTICLE".split(" "),ownLine:"area body head hr i?frame link meta noscript style script table tbody thead tfoot".split(" "),contOwnLine:"li dt dt h[1-6] option script".split(" "),newLevel:"blockquote div dl fieldset form frameset map ol p pre select td th tr ul".split(" "),
blockLevelElements:"P H1 H2 H3 H4 H5 H6 DD DL DT DIV LI BLOCKQUOTE OUTPUT FIGCAPTION PRE ADDRESS SECTION HEADER FOOTER ASIDE ARTICLE TD".split(" "),langs:{en:{html:"HTML",video:"Insert Video",image:"Insert Image",table:"Table",link:"Link",link_insert:"Insert link",link_edit:"Edit link",unlink:"Unlink",formatting:"Formatting",paragraph:"Normal text",quote:"Quote",code:"Code",header1:"Header 1",header2:"Header 2",header3:"Header 3",header4:"Header 4",header5:"Header 5",bold:"Bold",italic:"Italic",fontcolor:"Font Color",
backcolor:"Back Color",unorderedlist:"Unordered List",orderedlist:"Ordered List",outdent:"Outdent",indent:"Indent",cancel:"Cancel",insert:"Insert",save:"Save",_delete:"Delete",insert_table:"Insert Table",insert_row_above:"Add Row Above",insert_row_below:"Add Row Below",insert_column_left:"Add Column Left",insert_column_right:"Add Column Right",delete_column:"Delete Column",delete_row:"Delete Row",delete_table:"Delete Table",rows:"Rows",columns:"Columns",add_head:"Add Head",delete_head:"Delete Head",
title:"Title",image_position:"Position",none:"None",left:"Left",right:"Right",image_web_link:"Image Web Link",text:"Text",mailto:"Email",web:"URL",video_html_code:"Video Embed Code",file:"Insert File",upload:"Upload",download:"Download",choose:"Choose",or_choose:"Or choose",drop_file_here:"Drop file here",align_left:"Align text to the left",align_center:"Center text",align_right:"Align text to the right",align_justify:"Justify text",horizontalrule:"Insert Horizontal Rule",deleted:"Deleted",anchor:"Anchor",
link_new_tab:"Open link in new tab",underline:"Underline",alignment:"Alignment",filename:"Name (optional)",edit:"Edit"}}};q.fn=b.Redactor.prototype={keyCode:{BACKSPACE:8,DELETE:46,DOWN:40,ENTER:13,ESC:27,TAB:9,CTRL:17,META:91,LEFT:37,LEFT_WIN:91},init:function(a,c){this.rtePaste=!1;this.$element=this.$source=b(a);this.uuid=u++;var d=b.extend(!0,{},b.Redactor.opts);this.opts=b.extend({},d,this.$element.data(),c);this.start=!0;this.dropdowns=[];this.sourceHeight=this.$source.css("height");this.sourceWidth=
this.$source.css("width");this.opts.fullpage&&(this.opts.iframe=!0);this.opts.linebreaks&&(this.opts.paragraphy=!1);this.opts.paragraphy&&(this.opts.linebreaks=!1);this.opts.toolbarFixedBox&&(this.opts.toolbarFixed=!0);this.document=document;this.window=window;this.savedSel=!1;this.cleanlineBefore=RegExp("^<(/?"+this.opts.ownLine.join("|/?")+"|"+this.opts.contOwnLine.join("|")+")[ >]");this.cleanlineAfter=RegExp("^<(br|/?"+this.opts.ownLine.join("|/?")+"|/"+this.opts.contOwnLine.join("|/")+")[ >]");
this.cleannewLevel=RegExp("^</?("+this.opts.newLevel.join("|")+")[ >]");this.rTestBlock=RegExp("^("+this.opts.blockLevelElements.join("|")+")$","i");if(!1===this.opts.linebreaks){if(!1!==this.opts.allowedTags){var d=["strong","em","del"],e=["b","i","strike"];"-1"===b.inArray("p",this.opts.allowedTags)&&this.opts.allowedTags.push("p");for(i in d)"-1"!=b.inArray(d[i],this.opts.allowedTags)&&this.opts.allowedTags.push(e[i])}!1!==this.opts.deniedTags&&(d=b.inArray("p",this.opts.deniedTags),"-1"!==d&&
this.opts.deniedTags.splice(d,d))}if(this.browser("msie")||this.browser("opera"))this.opts.buttons=this.removeFromArrayByValue(this.opts.buttons,"horizontalrule");this.opts.curLang=this.opts.langs[this.opts.lang];this.buildStart()},toolbarInit:function(a){return{html:{title:a.html,func:"toggle"},formatting:{title:a.formatting,func:"show",dropdown:{p:{title:a.paragraph,func:"formatBlocks"},blockquote:{title:a.quote,func:"formatQuote",className:"redactor_format_blockquote"},pre:{title:a.code,func:"formatBlocks",
className:"redactor_format_pre"},h1:{title:a.header1,func:"formatBlocks",className:"redactor_format_h1"},h2:{title:a.header2,func:"formatBlocks",className:"redactor_format_h2"},h3:{title:a.header3,func:"formatBlocks",className:"redactor_format_h3"},h4:{title:a.header4,func:"formatBlocks",className:"redactor_format_h4"},h5:{title:a.header5,func:"formatBlocks",className:"redactor_format_h5"}}},bold:{title:a.bold,exec:"bold"},italic:{title:a.italic,exec:"italic"},deleted:{title:a.deleted,exec:"strikethrough"},
underline:{title:a.underline,exec:"underline"},unorderedlist:{title:"&bull; "+a.unorderedlist,exec:"insertunorderedlist"},orderedlist:{title:"1. "+a.orderedlist,exec:"insertorderedlist"},outdent:{title:"< "+a.outdent,func:"indentingOutdent"},indent:{title:"> "+a.indent,func:"indentingIndent"},image:{title:a.image,func:"imageShow"},video:{title:a.video,func:"videoShow"},file:{title:a.file,func:"fileShow"},table:{title:a.table,func:"show",dropdown:{insert_table:{title:a.insert_table,func:"tableShow"},
separator_drop1:{name:"separator"},insert_row_above:{title:a.insert_row_above,func:"tableAddRowAbove"},insert_row_below:{title:a.insert_row_below,func:"tableAddRowBelow"},insert_column_left:{title:a.insert_column_left,func:"tableAddColumnLeft"},insert_column_right:{title:a.insert_column_right,func:"tableAddColumnRight"},separator_drop2:{name:"separator"},add_head:{title:a.add_head,func:"tableAddHead"},delete_head:{title:a.delete_head,func:"tableDeleteHead"},separator_drop3:{name:"separator"},delete_column:{title:a.delete_column,
func:"tableDeleteColumn"},delete_row:{title:a.delete_row,func:"tableDeleteRow"},delete_table:{title:a.delete_table,func:"tableDeleteTable"}}},link:{title:a.link,func:"show",dropdown:{link:{title:a.link_insert,func:"linkShow"},unlink:{title:a.unlink,exec:"unlink"}}},fontcolor:{title:a.fontcolor,func:"show"},backcolor:{title:a.backcolor,func:"show"},alignment:{title:a.alignment,func:"show",dropdown:{alignleft:{title:a.align_left,func:"alignmentLeft"},aligncenter:{title:a.align_center,func:"alignmentCenter"},
alignright:{title:a.align_right,func:"alignmentRight"},justify:{title:a.align_justify,func:"alignmentJustify"}}},alignleft:{title:a.align_left,func:"alignmentLeft"},aligncenter:{title:a.align_center,func:"alignmentCenter"},alignright:{title:a.align_right,func:"alignmentRight"},justify:{title:a.align_justify,func:"alignmentJustify"},horizontalrule:{exec:"inserthorizontalrule",title:a.horizontalrule}}},callback:function(a,c,d){a=this.opts[a+"Callback"];return b.isFunction(a)?!1===c?a.call(this,d):a.call(this,
c,d):d},destroy:function(){clearInterval(this.autosaveInterval);b(window).off(".redactor");this.$source.off("redactor-textarea");this.$element.off(".redactor").removeData("redactor");var a=this.get();if(this.opts.textareamode)this.$box.after(this.$source),this.$box.remove(),this.$source.val(a).show();else{var c=this.$editor;this.opts.iframe&&(c=this.$element);this.$box.after(c);this.$box.remove();c.removeClass("redactor_editor").removeClass("redactor_editor_wym").removeAttr("contenteditable").html(a).show()}this.opts.air&&
b("#redactor_air_"+this.uuid).remove()},getObject:function(){return b.extend({},this)},getEditor:function(){return this.$editor},getBox:function(){return this.$box},getIframe:function(){return this.opts.iframe?this.$frame:!1},getToolbar:function(){return this.$toolbar?this.$toolbar:!1},get:function(){return this.$source.val()},getCodeIframe:function(){this.$editor.removeAttr("contenteditable").removeAttr("dir");var a=this.outerHtml(this.$frame.contents().children());this.$editor.attr({contenteditable:!0,
dir:this.opts.direction});return a},set:function(a,c,b){a=a.toString();this.opts.fullpage?this.setCodeIframe(a):this.setEditor(a,c);""==a&&(b=!1);!1!==b&&this.placeholderRemove()},setEditor:function(a,c){!1!==c&&(a=this.cleanSavePreCode(a),a=this.cleanStripTags(a),a=this.cleanConvertProtected(a),a=this.cleanConvertInlineTags(a,!0),a=!1===this.opts.linebreaks?this.cleanConverters(a):a.replace(/<p(.*?)>([\w\W]*?)<\/p>/gi,"$2<br>"));a=this.cleanEmpty(a);this.$editor.html(a);this.setNonEditable();this.setSpansVerified();
this.sync()},setCodeIframe:function(a){var c=this.iframePage();this.$frame[0].src="about:blank";a=this.cleanConvertProtected(a);a=this.cleanConvertInlineTags(a);a=this.cleanRemoveSpaces(a);c.open();c.write(a);c.close();this.opts.fullpage&&(this.$editor=this.$frame.contents().find("body").attr({contenteditable:!0,dir:this.opts.direction}));this.setNonEditable();this.setSpansVerified();this.sync()},setFullpageOnInit:function(a){a=this.cleanSavePreCode(a,!0);a=this.cleanConverters(a);a=this.cleanEmpty(a);
this.$editor.html(a);this.setNonEditable();this.setSpansVerified();this.sync()},setSpansVerified:function(){var a=this.$editor.find("span");b.each(a,function(){var a=RegExp("<"+this.tagName,"gi"),d=this.outerHTML.replace(a,"<inline"),a=RegExp("</"+this.tagName,"gi"),d=d.replace(a,"</inline");b(this).replaceWith(d)})},setSpansVerifiedHtml:function(a){a=a.replace(/<span(.*?)>/,"<inline$1>");return a.replace(/<\/span>/,"</inline>")},setNonEditable:function(){this.$editor.find(".noneditable").attr("contenteditable",
!1)},sync:function(){var a="";this.cleanUnverified();a=this.opts.fullpage?this.getCodeIframe():this.$editor.html();a=this.syncClean(a);a=this.cleanRemoveEmptyTags(a);a=a.replace(/<\/li><(ul|ol)>([\w\W]*?)<\/(ul|ol)>/gi,"<$1>$2</$1></li>");"<br>"===b.trim(a)&&(a="");this.opts.xhtml&&b.each("br hr img link input meta".split(" "),function(c,b){a=a.replace(RegExp("<"+b+"(.*?[^/$]?)>","gi"),"<"+b+"$1 />")});a=this.callback("syncBefore",!1,a);this.$source.val(a);this.callback("syncAfter",!1,a);!1===this.start&&
this.callback("change",!1,a)},syncClean:function(a){this.opts.fullpage||(a=this.cleanStripTags(a));a=b.trim(a);a=this.placeholderRemoveFromCode(a);a=a.replace(/&#x200b;/gi,"");a=a.replace(/&#8203;/gi,"");a=a.replace(/<\/a>&nbsp;/gi,"</a> ");this.opts.linkNofollow&&(a=a.replace(/<a(.*?)rel="nofollow"(.*?)>/gi,"<a$1$2>"),a=a.replace(/<a(.*?)>/gi,'<a$1 rel="nofollow">'));a=a.replace("\x3c!--?php","<?php");a=a.replace("?--\x3e","?>");a=a.replace(/<(.*?)class="noeditable"(.*?) contenteditable="false"(.*?)>/gi,
'<$1class="noeditable"$2$3>');a=a.replace(/ data-tagblock=""/gi,"");a=a.replace(/<br\s?\/?>\n?<\/(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)>/gi,"</$1>");a=a.replace(/<span(.*?)id="redactor-image-box"(.*?)>([\w\W]*?)<img(.*?)><\/span>/i,"$3<img$4>");a=a.replace(/<span(.*?)id="redactor-image-resizer"(.*?)>(.*?)<\/span>/i,"");a=a.replace(/<span(.*?)id="redactor-image-editter"(.*?)>(.*?)<\/span>/i,"");a=a.replace(/<font(.*?)>([\w\W]*?)<\/font>/gi,"$2");a=a.replace(/<span(.*?)>([\w\W]*?)<\/span>/gi,
"$2");a=a.replace(/<inline>/gi,"<span>");a=a.replace(/<inline /gi,"<span ");a=a.replace(/<\/inline>/gi,"</span>");a=a.replace(/<span(.*?)class="redactor_placeholder"(.*?)>([\w\W]*?)<\/span>/gi,"");a=a.replace(/&amp;/gi,"&");a=a.replace(/\u2122/gi,"&trade;");a=a.replace(/\u00a9/gi,"&copy;");return a=this.cleanReConvertProtected(a)},buildStart:function(){this.content="";this.$box=b('<div class="redactor_box" />');"TEXTAREA"===this.$source[0].tagName&&(this.opts.textareamode=!0);!1===this.opts.mobile&&
this.isMobile()?this.buildMobile():(this.buildContent(),this.opts.iframe?(this.opts.autoresize=!1,this.iframeStart()):this.opts.textareamode?this.buildFromTextarea():this.buildFromElement(),this.opts.iframe||(this.buildOptions(),this.buildAfter()))},buildMobile:function(){this.opts.textareamode||(this.$editor=this.$source,this.$editor.hide(),this.$source=this.buildCodearea(this.$editor),this.$source.val(this.content));this.$box.insertAfter(this.$source).append(this.$source)},buildContent:function(){this.content=
this.opts.textareamode?b.trim(this.$source.val()):b.trim(this.$source.html())},buildFromTextarea:function(){this.$editor=b("<div />");this.$box.insertAfter(this.$source).append(this.$editor).append(this.$source);this.buildAddClasses(this.$editor);this.buildEnable()},buildFromElement:function(){this.$editor=this.$source;this.$source=this.buildCodearea(this.$editor);this.$box.insertAfter(this.$editor).append(this.$editor).append(this.$source);this.buildEnable()},buildCodearea:function(a){return b("<textarea />").attr("name",
a.attr("id")).css("height",this.sourceHeight)},buildAddClasses:function(a){b.each(this.$source.get(0).className.split(/\s+/),function(c,b){a.addClass("redactor_"+b)})},buildEnable:function(){this.$editor.addClass("redactor_editor").attr({contenteditable:!0,dir:this.opts.direction});this.$source.attr("dir",this.opts.direction).hide();this.set(this.content,!0,!1)},buildOptions:function(){var a=this.$editor;this.opts.iframe&&(a=this.$frame);this.opts.tabindex&&a.attr("tabindex",this.opts.tabindex);this.opts.minHeight&&
a.css("min-height",this.opts.minHeight+"px");this.opts.maxHeight&&(this.opts.autoresize=!1,a.css("max-height",this.opts.maxHeight+"px"));this.opts.wym&&this.$editor.addClass("redactor_editor_wym");this.opts.autoresize||a.css("height",this.sourceHeight)},buildAfter:function(){this.start=!1;this.opts.toolbar&&(this.opts.toolbar=this.toolbarInit(this.opts.curLang),this.toolbarBuild());this.modalTemplatesInit();this.buildPlugins();this.buildBindKeyboard();this.opts.autosave&&this.autosave();setTimeout(b.proxy(this.observeStart,
this),4);if(this.browser("mozilla"))try{this.document.execCommand("enableObjectResizing",!1,!1),this.document.execCommand("enableInlineTableEditing",!1,!1)}catch(a){}this.opts.focus&&setTimeout(b.proxy(this.focus,this),100);this.opts.visual||setTimeout(b.proxy(function(){this.opts.visual=!0;this.toggle(!1)},this),200);this.callback("init")},buildBindKeyboard:function(){this.dblEnter=0;if(this.opts.dragUpload&&!1!==this.opts.imageUpload)this.$editor.on("drop.redactor",b.proxy(this.buildEventDrop,this));
this.$editor.on("paste.redactor",b.proxy(this.buildEventPaste,this));this.$editor.on("keydown.redactor",b.proxy(this.buildEventKeydown,this));this.$editor.on("keyup.redactor",b.proxy(this.buildEventKeyup,this));if(b.isFunction(this.opts.textareaKeydownCallback))this.$source.on("keydown.redactor-textarea",b.proxy(this.opts.textareaKeydownCallback,this));if(b.isFunction(this.opts.focusCallback))this.$editor.on("focus.redactor",b.proxy(this.opts.focusCallback,this));var a;b(document).mousedown(function(c){a=
b(c.target)});this.$editor.on("blur.redactor",b.proxy(function(c){b(a).hasClass("redactor_toolbar")||0!=b(a).parents(".redactor_toolbar").size()||(this.selectall=!1,b.isFunction(this.opts.blurCallback)&&this.callback("blur",c))},this))},buildEventDrop:function(a){a=a.originalEvent||a;if(void 0===window.FormData||!a.dataTransfer||0==a.dataTransfer.files.length)return!0;a.preventDefault();var c=a.dataTransfer.files[0];if(!1!==this.opts.dnbImageTypes&&-1==this.opts.dnbImageTypes.indexOf(c.type))return!0;
this.bufferSet();var d=b('<div id="redactor-progress-drag" class="redactor-progress redactor-progress-striped"><div id="redactor-progress-bar" class="redactor-progress-bar" style="width: 100%;"></div></div>');b(document.body).append(d);!1===this.opts.s3?this.dragUploadAjax(this.opts.imageUpload,c,!0,d,a,this.opts.imageUploadParam):this.s3uploadFile(c)},buildEventPaste:function(a){var c=!1;this.browser("webkit")&&-1===navigator.userAgent.indexOf("Chrome")&&536>this.browser("version").split(".")[0]&&
(c=!0);if(c||this.browser("opera")||this.opts.clipboardUpload&&this.buildEventClipboardUpload(a))return!0;if(this.opts.cleanup){this.rtePaste=!0;this.selectionSave();this.selectall||(!0===this.opts.autoresize&&!0!==this.fullscreen?(this.$editor.height(this.$editor.height()),this.saveScroll=this.document.body.scrollTop):this.saveScroll=this.$editor.scrollTop());var d=this.extractContent();setTimeout(b.proxy(function(){var a=this.extractContent();this.$editor.append(d);this.selectionRestore();a=this.getFragmentHtml(a);
this.pasteClean(a);!0===this.opts.autoresize&&!0!==this.fullscreen&&this.$editor.css("height","auto")},this),1)}},buildEventClipboardUpload:function(a){a=a.originalEvent||a;this.clipboardFilePaste=!1;if("undefined"===typeof a.clipboardData)return!1;if(a.clipboardData.items&&(a=a.clipboardData.items[0].getAsFile(),null!==a)){this.bufferSet();this.clipboardFilePaste=!0;var c=new FileReader;c.onload=b.proxy(this.pasteClipboardUpload,this);c.readAsDataURL(a);return!0}return!1},buildEventKeydown:function(a){if(this.rtePaste)return!1;
var c=a.which,d=a.ctrlKey||a.metaKey,e=this.getParent(),f=this.getCurrent(),g=this.getBlock(),h=!1;this.callback("keydown",a);this.imageResizeHide(!1);if(e&&"PRE"===b(e).get(0).tagName||f&&"PRE"===b(f).get(0).tagName)h=!0,c===this.keyCode.DOWN&&this.insertAfterLastElement(g);c===this.keyCode.DOWN&&(e&&"BLOCKQUOTE"===b(e)[0].tagName&&this.insertAfterLastElement(e),f&&"BLOCKQUOTE"===b(f)[0].tagName&&this.insertAfterLastElement(f),e&&"P"===b(e)[0].tagName&&"BLOCKQUOTE"==b(e).parent()[0].tagName&&this.insertAfterLastElement(e,
b(e).parent()[0]),f&&"P"===b(f)[0].tagName&&e&&"BLOCKQUOTE"==b(e)[0].tagName&&this.insertAfterLastElement(f,e));d&&!a.shiftKey&&this.shortcuts(a,c);if(!d||90!==c||a.shiftKey||a.altKey)if(d&&90===c&&a.shiftKey&&!a.altKey)a.preventDefault(),0!=this.opts.rebuffer.length?this.bufferRedo():this.document.execCommand("redo",!1,!1);else{d&&65===c?this.selectall=!0:c==this.keyCode.LEFT_WIN||d||(this.selectall=!1);if(c!=this.keyCode.ENTER||a.shiftKey||a.ctrlKey||a.metaKey)c===this.keyCode.ENTER&&(a.ctrlKey||
a.shiftKey)&&(this.bufferSet(),a.preventDefault(),this.insertLineBreak());else{if(this.browser("msie")&&1==e.nodeType&&("TD"==e.tagName||"TH"==e.tagName))return a.preventDefault(),this.bufferSet(),this.insertNode(document.createElement("br")),this.callback("enter",a),!1;if(g&&("BLOCKQUOTE"==g.tagName||"BLOCKQUOTE"==b(g).parent()[0].tagName)){if(this.isEndOfElement()&&1==this.dblEnter){"BLOCKQUOTE"==g.tagName?(d="br",c=g):(d="p",c=b(g).parent()[0]);a.preventDefault();this.insertingAfterLastElement(c);
this.dblEnter=0;"p"==d?b(g).parent().find("p").last().remove():(a=b.trim(b(g).html()),b(g).html(a.replace(/<br\s?\/?>$/i,"")));return}this.dblEnter++}if(!0===h)return this.buildEventKeydownPre(a,f);if(!this.opts.linebreaks)if(g&&this.opts.rBlockTest.test(g.tagName))this.bufferSet(),setTimeout(b.proxy(function(){var a=this.getBlock();if("DIV"===a.tagName&&!b(a).hasClass("redactor_editor")){var c=b("<p>"+this.opts.invisibleSpace+"</p>");b(a).replaceWith(c);this.selectionStart(c)}},this),1);else if(!1===
g)return this.bufferSet(),g=b("<p>"+this.opts.invisibleSpace+"</p>"),this.insertNode(g[0]),this.selectionStart(g),this.callback("enter",a),!1;if(this.opts.linebreaks)if(g&&this.opts.rBlockTest.test(g.tagName))this.bufferSet(),setTimeout(b.proxy(function(){var a=this.getBlock();"DIV"!==a.tagName&&"P"!==a.tagName||b(a).hasClass("redactor_editor")||this.replaceLineBreak(a)},this),1);else return this.buildEventKeydownInsertLineBreak(a);if("BLOCKQUOTE"==g.tagName||"FIGCAPTION"==g.tagName)return this.buildEventKeydownInsertLineBreak(a);
this.callback("enter",a)}if(c===this.keyCode.TAB&&this.opts.shortcuts)return this.buildEventKeydownTab(a,h);c===this.keyCode.BACKSPACE&&this.buildEventKeydownBackspace(f)}else a.preventDefault(),this.opts.buffer.length?this.bufferUndo():this.document.execCommand("undo",!1,!1)},buildEventKeydownPre:function(a,c){a.preventDefault();this.bufferSet();var d=b(c).parent().text();this.insertNode(document.createTextNode("\n"));-1==d.search(/\s$/)&&this.insertNode(document.createTextNode("\n"));this.sync();
this.callback("enter",a);return!1},buildEventKeydownTab:function(a,c){if(!this.opts.tabFocus||this.isEmpty(this.get())&&!1===this.opts.tabSpaces)return!0;a.preventDefault();!0!==c||a.shiftKey?!1!==this.opts.tabSpaces?(this.bufferSet(),this.insertNode(document.createTextNode(Array(this.opts.tabSpaces+1).join("\u00a0"))),this.sync()):a.shiftKey?this.indentingOutdent():this.indentingIndent():(this.bufferSet(),this.insertNode(document.createTextNode("\t")),this.sync());return!1},buildEventKeydownBackspace:function(a){if("undefined"!==
typeof a.tagName&&/^(H[1-6])$/i.test(a.tagName)){var c;c=!1===this.opts.linebreaks?b("<p>"+this.opts.invisibleSpace+"</p>"):b("<br>"+this.opts.invisibleSpace);b(a).replaceWith(c);this.selectionStart(c)}"undefined"!==typeof a.nodeValue&&null!==a.nodeValue&&a.remove&&3===a.nodeType&&null==a.nodeValue.match(/[^/\u200B]/g)&&a.remove()},buildEventKeydownInsertLineBreak:function(a){this.bufferSet();a.preventDefault();this.insertLineBreak();this.callback("enter",a)},buildEventKeyup:function(a){if(this.rtePaste)return!1;
var c=a.which,d=this.getParent(),e=this.getCurrent();this.opts.linebreaks||3!=e.nodeType||!1!=d&&"BODY"!=d.tagName||(d=b("<p>").append(b(e).clone()),b(e).replaceWith(d),e=b(d).next(),"undefined"!==typeof e[0]&&"BR"==e[0].tagName&&e.remove(),this.selectionEnd(d));(this.opts.convertLinks||this.opts.convertImageLinks||this.opts.convertVideoLinks)&&c===this.keyCode.ENTER&&this.buildEventKeyupConverters();if(c===this.keyCode.DELETE||c===this.keyCode.BACKSPACE)return this.formatEmpty(a);this.callback("keyup",
a);this.sync()},buildEventKeyupConverters:function(){this.formatLinkify(this.opts.linkProtocol,this.opts.convertLinks,this.opts.convertImageLinks,this.opts.convertVideoLinks,this.opts.linkSize);setTimeout(b.proxy(function(){this.opts.convertImageLinks&&this.observeImages();this.opts.observeLinks&&this.observeLinks()},this),5)},buildPlugins:function(){this.opts.plugins&&b.each(this.opts.plugins,b.proxy(function(a,c){RedactorPlugins[c]&&(b.extend(this,RedactorPlugins[c]),b.isFunction(RedactorPlugins[c].init)&&
this.init())},this))},iframeStart:function(){this.iframeCreate();this.opts.textareamode?this.iframeAppend(this.$source):(this.$sourceOld=this.$source.hide(),this.$source=this.buildCodearea(this.$sourceOld),this.iframeAppend(this.$sourceOld))},iframeAppend:function(a){this.$source.attr("dir",this.opts.direction).hide();this.$box.insertAfter(a).append(this.$frame).append(this.$source)},iframeCreate:function(){this.$frame=b('<iframe style="width: 100%;" frameborder="0" />').one("load",b.proxy(function(){if(this.opts.fullpage){this.iframePage();
""===this.content&&(this.content=this.opts.invisibleSpace);this.$frame.contents()[0].write(this.content);this.$frame.contents()[0].close();var a=setInterval(b.proxy(function(){this.$frame.contents().find("body").html()&&(clearInterval(a),this.iframeLoad())},this),0)}else this.iframeLoad()},this))},iframeDoc:function(){return this.$frame[0].contentWindow.document},iframePage:function(){var a=this.iframeDoc();a.documentElement&&a.removeChild(a.documentElement);return a},iframeAddCss:function(a){a=a||
this.opts.css;this.isString(a)&&this.$frame.contents().find("head").append('<link rel="stylesheet" href="'+a+'" />');b.isArray(a)&&b.each(a,b.proxy(function(a,b){this.iframeAddCss(b)},this))},iframeLoad:function(){this.$editor=this.$frame.contents().find("body").attr({contenteditable:!0,dir:this.opts.direction});this.$editor[0]&&(this.document=this.$editor[0].ownerDocument,this.window=this.document.defaultView||window);this.iframeAddCss();this.opts.fullpage?this.setFullpageOnInit(this.$editor.html()):
this.set(this.content,!0,!1);this.buildOptions();this.buildAfter()},placeholderStart:function(a){return this.isEmpty(a)&&(this.$element.attr("placeholder")&&(this.opts.placeholder=this.$element.attr("placeholder")),""===this.opts.placeholder&&(this.opts.placeholder=!1),!1!==this.opts.placeholder)?(this.opts.focus=!1,this.$editor.one("focus.redactor_placeholder",b.proxy(this.placeholderFocus,this)),b('<span class="redactor_placeholder" data-redactor="verified">').attr("contenteditable",!1).text(this.opts.placeholder)):
!1},placeholderFocus:function(){this.$editor.find("span.redactor_placeholder").remove();var a="";!1===this.opts.linebreaks&&(a=this.opts.emptyHtml);this.$editor.off("focus.redactor_placeholder");this.$editor.html(a);!1===this.opts.linebreaks?this.selectionStart(this.$editor.children()[0]):this.focus();this.sync()},placeholderRemove:function(){this.opts.placeholder=!1;this.$editor.find("span.redactor_placeholder").remove();this.$editor.off("focus.redactor_placeholder")},placeholderRemoveFromCode:function(a){return a.replace(/<span class="redactor_placeholder"(.*?)>(.*?)<\/span>/i,
"")},shortcuts:function(a,c){this.opts.shortcuts&&(a.altKey?48===c?this.shortcutsLoadFormat(a,"p"):49===c?this.shortcutsLoadFormat(a,"h1"):50===c?this.shortcutsLoadFormat(a,"h2"):51===c?this.shortcutsLoadFormat(a,"h3"):52===c?this.shortcutsLoadFormat(a,"h4"):53===c?this.shortcutsLoadFormat(a,"h5"):54===c&&this.shortcutsLoadFormat(a,"h6"):77===c?this.shortcutsLoad(a,"removeFormat"):66===c?this.shortcutsLoad(a,"bold"):73===c?this.shortcutsLoad(a,"italic"):74===c?this.shortcutsLoad(a,"insertunorderedlist"):
75===c?this.shortcutsLoad(a,"insertorderedlist"):72===c?this.shortcutsLoad(a,"superscript"):76===c&&this.shortcutsLoad(a,"subscript"))},shortcutsLoad:function(a,c){a.preventDefault();this.execCommand(c,!1)},shortcutsLoadFormat:function(a,c){a.preventDefault();this.formatBlocks(c)},focus:function(){this.browser("opera")?this.$editor.focus():this.window.setTimeout(b.proxy(this.focusSet,this,!0),1)},focusEnd:function(){this.focusSet()},focusSet:function(a){this.$editor.focus();var c=this.getRange();
c.selectNodeContents(this.$editor[0]);c.collapse(a||!1);a=this.getSelection();a.removeAllRanges();a.addRange(c)},toggle:function(a){this.opts.visual?this.toggleCode(a):this.toggleVisual()},toggleVisual:function(){var a=this.$source.hide().val();"undefined"!==typeof this.modified&&(this.modified=this.cleanRemoveSpaces(this.modified,!1)!==this.cleanRemoveSpaces(a,!1));this.modified&&(this.opts.fullpage&&""===a?this.setFullpageOnInit(a):(this.set(a),this.opts.fullpage&&this.buildBindKeyboard()));this.opts.iframe?
this.$frame.show():this.$editor.show();this.opts.fullpage&&this.$editor.attr("contenteditable",!0);this.$source.off("keydown.redactor-textarea-indenting");this.$editor.focus();this.selectionRestore();this.observeStart();this.buttonActiveVisual();this.buttonInactive("html");this.opts.visual=!0},toggleCode:function(a){!1!==a&&this.selectionSave();a=null;this.opts.iframe?(a=this.$frame.height(),this.opts.fullpage&&this.$editor.removeAttr("contenteditable"),this.$frame.hide()):(a=this.$editor.innerHeight(),
this.$editor.hide());var c=this.$source.val();""!==c&&this.opts.tidyHtml&&this.$source.val(this.cleanHtml(c));this.modified=c;this.$source.height(a).show().focus();this.$source.on("keydown.redactor-textarea-indenting",this.textareaIndenting);this.buttonInactiveVisual();this.buttonActive("html");this.opts.visual=!1},textareaIndenting:function(a){if(9===a.keyCode){a=b(this);var c=a.get(0).selectionStart;a.val(a.val().substring(0,c)+"\t"+a.val().substring(a.get(0).selectionEnd));a.get(0).selectionStart=
a.get(0).selectionEnd=c+1;return!1}},autosave:function(){var a=!1;this.autosaveInterval=setInterval(b.proxy(function(){var c=this.get();a!==c&&b.ajax({url:this.opts.autosave,type:"post",data:this.$source.attr("name")+"="+escape(encodeURIComponent(c)),success:b.proxy(function(b){this.callback("autosave",!1,b);a=c},this)})},this),1E3*this.opts.autosaveInterval)},toolbarBuild:function(){if(this.opts.air)this.opts.buttons=this.opts.airButtons;else if(!this.opts.buttonSource){var a=this.opts.buttons.indexOf("html"),
c=this.opts.buttons[a+1];this.opts.buttons.splice(a,1);"|"===c&&this.opts.buttons.splice(a,1)}b.extend(this.opts.toolbar,this.opts.buttonsCustom);b.each(this.opts.buttonsAdd,b.proxy(function(a,c){this.opts.buttons.push(c)},this));this.opts.toolbar&&b.each(this.opts.toolbar.formatting.dropdown,b.proxy(function(a,c){"-1"==b.inArray(a,this.opts.formattingTags)&&delete this.opts.toolbar.formatting.dropdown[a]},this));if(0===this.opts.buttons.length)return!1;this.airEnable();this.$toolbar=b("<ul>").addClass("redactor_toolbar").attr("id",
"redactor_toolbar_"+this.uuid);this.opts.air?(this.$air=b('<div class="redactor_air">').attr("id","redactor_air_"+this.uuid).hide(),this.$air.append(this.$toolbar),b("body").append(this.$air)):this.opts.toolbarExternal?b(this.opts.toolbarExternal).html(this.$toolbar):this.$box.prepend(this.$toolbar);b.each(this.opts.buttons,b.proxy(function(a,c){if("|"===c)this.$toolbar.append(b(this.opts.buttonSeparator));else if(this.opts.toolbar[c]){var f=this.opts.toolbar[c];if(!1===this.opts.fileUpload&&"file"===
c)return!0;this.$toolbar.append(b("<li>").append(this.buttonBuild(c,f)))}},this));this.$toolbar.find("a").attr("tabindex","-1");this.opts.toolbarFixed&&(this.toolbarObserveScroll(),b(this.opts.toolbarFixedTarget).on("scroll.redactor",b.proxy(this.toolbarObserveScroll,this)));this.opts.activeButtons&&(a=b.proxy(this.buttonActiveObserver,this),this.$editor.on("mouseup.redactor keyup.redactor",a))},toolbarObserveScroll:function(){var a=b(this.opts.toolbarFixedTarget).scrollTop(),c=this.$box.offset().top,
d=0,e=c+this.$box.height()+40;a>c?(c="100%",this.opts.toolbarFixedBox&&(d=this.$box.offset().left,c=this.$box.innerWidth(),this.$toolbar.addClass("toolbar_fixed_box")),this.toolbarFixed=!0,this.$toolbar.css({position:"fixed",width:c,zIndex:1005,top:this.opts.toolbarFixedTopOffset+"px",left:d}),a<e?this.$toolbar.css("visibility","visible"):this.$toolbar.css("visibility","hidden")):(this.toolbarFixed=!1,this.$toolbar.css({position:"relative",width:"auto",top:0,left:d}),this.opts.toolbarFixedBox&&this.$toolbar.removeClass("toolbar_fixed_box"))},
airEnable:function(){if(this.opts.air)this.$editor.on("mouseup.redactor keyup.redactor",this,b.proxy(function(a){var c=this.getSelectionText();"mouseup"===a.type&&""!=c&&this.airShow(a);"keyup"===a.type&&a.shiftKey&&""!=c&&(a=b(this.getElement(this.getSelection().focusNode)),c=a.offset(),c.height=a.height(),this.airShow(c,!0))},this))},airShow:function(a,c){if(this.opts.air){var d,e;b(".redactor_air").hide();c?(d=a.left,e=a.top+a.height+14,this.opts.iframe&&(e+=this.$box.position().top-b(this.document).scrollTop(),
d+=this.$box.position().left)):(e=this.$air.innerWidth(),d=a.clientX,b(this.document).width()<d+e&&(d-=e),e=a.clientY+14,this.opts.iframe?(e+=this.$box.position().top,d+=this.$box.position().left):e+=b(this.document).scrollTop());this.$air.css({left:d+"px",top:e+"px"}).show();this.airBindHide()}},airBindHide:function(){if(this.opts.air){var a=b.proxy(function(a){b(a).on("mousedown.redactor",b.proxy(function(d){0===b(d.target).closest(this.$toolbar).length&&(this.$air.fadeOut(100),this.selectionRemove(),
b(a).off(d))},this)).on("keydown.redactor",b.proxy(function(d){d.which===this.keyCode.ESC&&this.getSelection().collapseToStart();this.$air.fadeOut(100);b(a).off(d)},this))},this);a(document);this.opts.iframe&&a(this.document)}},airBindMousemoveHide:function(){if(this.opts.air){var a=b.proxy(function(a){b(a).on("mousemove.redactor",b.proxy(function(d){0===b(d.target).closest(this.$toolbar).length&&(this.$air.fadeOut(100),b(a).off(d))},this))},this);a(document);this.opts.iframe&&a(this.document)}},
dropdownBuild:function(a,c){b.each(c,b.proxy(function(c,e){e.className||(e.className="");var f;"separator"===e.name?f=b('<a class="redactor_separator_drop">'):(f=b('<a href="#" class="'+e.className+" redactor_dropdown_"+c+'">'+e.title+"</a>"),f.on("click",b.proxy(function(a){a.preventDefault&&a.preventDefault();this.browser("msie")&&(a.returnValue=!1);e.callback&&e.callback.call(this,c,f,e,a);e.exec&&this.execCommand(e.exec,c);if(e.func)this[e.func](c);this.buttonActiveObserver();this.opts.air&&this.$air.fadeOut(100)},
this)));a.append(f)},this))},dropdownShow:function(a,c){if(!this.opts.visual)return a.preventDefault(),!1;var d=this.$toolbar.find(".redactor_dropdown_box_"+c),e=this.buttonGet(c);if(e.hasClass("dropact"))this.dropdownHideAll();else{this.dropdownHideAll();this.buttonActive(c);e.addClass("dropact");var f=e.position();this.toolbarFixed&&(f=e.offset());e=d.width();f.left+e>b(document).width()&&(f.left-=e);var e=f.left+"px",g="absolute",h="29px";this.opts.toolbarFixed&&this.toolbarFixed?g="fixed":this.opts.air||
(h=f.top+29+"px");d.css({position:g,left:e,top:h}).show()}f=b.proxy(function(a){this.dropdownHide(a,d)},this);b(document).one("click",f);this.$editor.one("click",f);a.stopPropagation()},dropdownHideAll:function(){this.$toolbar.find("a.dropact").removeClass("redactor_act").removeClass("dropact");b(".redactor_dropdown").hide()},dropdownHide:function(a,c){b(a.target).hasClass("dropact")||(c.removeClass("dropact"),this.dropdownHideAll())},buttonBuild:function(a,c){var d=b('<a href="javascript:;" title="'+
c.title+'" tabindex="-1" class="redactor_btn redactor_btn_'+a+'"></a>');d.on("click",b.proxy(function(b){b.preventDefault&&b.preventDefault();this.browser("msie")&&(b.returnValue=!1);if(d.hasClass("redactor_button_disabled"))return!1;!1!==this.isFocused()||c.exec||this.$editor.focus();c.exec?(this.$editor.focus(),this.execCommand(c.exec,a),this.airBindMousemoveHide()):c.func&&"show"!==c.func?(this[c.func](a),this.airBindMousemoveHide()):c.callback?(c.callback.call(this,a,d,c,b),this.airBindMousemoveHide()):
c.dropdown&&this.dropdownShow(b,a);this.buttonActiveObserver(!1,a)},this));if(c.dropdown){var e=b('<div class="redactor_dropdown redactor_dropdown_box_'+a+'" style="display: none;">');e.appendTo(this.$toolbar);this.dropdownBuild(e,c.dropdown)}return d},buttonGet:function(a){return this.opts.toolbar?b(this.$toolbar.find("a.redactor_btn_"+a)):!1},buttonActiveToggle:function(a){a=this.buttonGet(a);a.hasClass("redactor_act")?a.removeClass("redactor_act"):a.addClass("redactor_act")},buttonActive:function(a){this.buttonGet(a).addClass("redactor_act")},
buttonInactive:function(a){this.buttonGet(a).removeClass("redactor_act")},buttonInactiveAll:function(a){b.each(this.opts.toolbar,b.proxy(function(c){c!=a&&this.buttonInactive(c)},this))},buttonActiveVisual:function(){this.$toolbar.find("a.redactor_btn").not("a.redactor_btn_html").removeClass("redactor_button_disabled")},buttonInactiveVisual:function(){this.$toolbar.find("a.redactor_btn").not("a.redactor_btn_html").addClass("redactor_button_disabled")},buttonChangeIcon:function(a,c){this.buttonGet(a).addClass("redactor_btn_"+
c)},buttonRemoveIcon:function(a,c){this.buttonGet(a).removeClass("redactor_btn_"+c)},buttonAddSeparator:function(){this.$toolbar.append(b(this.opts.buttonSeparator))},buttonAddSeparatorAfter:function(a){this.buttonGet(a).parent().after(b(this.opts.buttonSeparator))},buttonAddSeparatorBefore:function(a){this.buttonGet(a).parent().before(b(this.opts.buttonSeparator))},buttonRemoveSeparatorAfter:function(a){this.buttonGet(a).parent().next().remove()},buttonRemoveSeparatorBefore:function(a){this.buttonGet(a).parent().prev().remove()},
buttonSetRight:function(a){this.opts.toolbar&&this.buttonGet(a).parent().addClass("redactor_btn_right")},buttonSetLeft:function(a){this.opts.toolbar&&this.buttonGet(a).parent().removeClass("redactor_btn_right")},buttonAdd:function(a,c,d,e){this.opts.toolbar&&(a=this.buttonBuild(a,{title:c,callback:d,dropdown:e}),this.$toolbar.append(b("<li>").append(a)))},buttonAddFirst:function(a,c,d,e){this.opts.toolbar&&(a=this.buttonBuild(a,{title:c,callback:d,dropdown:e}),this.$toolbar.prepend(b("<li>").append(a)))},
buttonAddAfter:function(a,c,d,e,f){this.opts.toolbar&&(c=this.buttonBuild(c,{title:d,callback:e,dropdown:f}),a=this.buttonGet(a),0!==a.size()?a.parent().after(b("<li>").append(c)):this.$toolbar.append(b("<li>").append(c)))},buttonAddBefore:function(a,c,d,e,f){this.opts.toolbar&&(c=this.buttonBuild(c,{title:d,callback:e,dropdown:f}),a=this.buttonGet(a),0!==a.size()?a.parent().before(b("<li>").append(c)):this.$toolbar.append(b("<li>").append(c)))},buttonRemove:function(a,c){var b=this.buttonGet(a);
c&&b.parent().next().remove();b.parent().removeClass("redactor_btn_right");b.remove()},buttonActiveObserver:function(a,c){var d=this.getParent();this.buttonInactiveAll(c);if(!1===a&&"html"!==c)-1!=b.inArray(c,this.opts.activeButtons)&&this.buttonActiveToggle(c);else{d&&"A"===d.tagName?this.$toolbar.find("a.redactor_dropdown_link").text(this.opts.curLang.link_edit):this.$toolbar.find("a.redactor_dropdown_link").text(this.opts.curLang.link_insert);this.opts.activeButtonsAdd&&(b.each(this.opts.activeButtonsAdd,
b.proxy(function(a,c){this.opts.activeButtons.push(c)},this)),b.extend(this.opts.activeButtonsStates,this.opts.activeButtonsAdd));b.each(this.opts.activeButtonsStates,b.proxy(function(a,c){0!=b(d).closest(a,this.$editor.get()[0]).length&&this.buttonActive(c)},this));var e=b(d).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);if(e.length)switch(e.css("text-align")){case "right":this.buttonActive("alignright");break;case "center":this.buttonActive("aligncenter");break;case "justify":this.buttonActive("justify");
break;default:this.buttonActive("alignleft")}}},exec:function(a,c,b){"formatblock"===a&&this.browser("msie")&&(c="<"+c+">");"inserthtml"===a&&this.browser("msie")?(this.$editor.focus(),this.document.selection.createRange().pasteHTML(c)):this.document.execCommand(a,!1,c);!1!==b&&this.sync();this.callback("execCommand",a,c)},execCommand:function(a,c,b){if(!this.opts.visual)return this.$source.focus(),!1;if("inserthtml"===a)this.insertHtml(c,b),this.callback("execCommand",a,c);else{if(this.currentOrParentIs("PRE")&&
!this.opts.formattingPre)return!1;if("insertunorderedlist"===a||"insertorderedlist"===a)return this.execLists(a,c);if("unlink"===a)return this.execUnlink(a,c);this.exec(a,c,b);"inserthorizontalrule"===a&&this.$editor.find("hr").removeAttr("id")}},execUnlink:function(a,c){this.bufferSet();var d=this.currentOrParentIs("A");d&&(b(d).replaceWith(b(d).text()),this.sync(),this.callback("execCommand",a,c))},execLists:function(a,c){this.bufferSet();var d=this.getParent(),e=b(d).closest("ol, ul"),d=!1;if(e.length){var d=
!0,f=e[0].tagName;if("insertunorderedlist"===a&&"OL"===f||"insertorderedlist"===a&&"UL"===f)d=!1}this.selectionSave();if(d){e=this.getNodes();d=this.getBlocks(e);"undefined"!=typeof e[0]&&1<e.length&&3==e[0].nodeType&&d.unshift(this.getBlock());var g="",h="";b.each(d,b.proxy(function(a,c){if("LI"==c.tagName){var d=b(c),e=d.clone();e.find("ul","ol").remove();g=!1===this.opts.linebreaks?g+this.outerHtml(b("<p>").append(e.contents())):g+(e.html()+"<br>");0==a?(d.addClass("redactor-replaced").empty(),
h=this.outerHtml(d)):d.remove()}},this));html=this.$editor.html().replace(h,"</"+f+">"+g+"<"+f+">");this.$editor.html(html);this.$editor.find(f+":empty").remove()}else f=this.getParent(),this.document.execCommand(a),d=this.getParent(),e=b(d).closest("ol, ul"),f&&"TD"==f.tagName&&e.wrapAll("<td>"),e.length&&((this.browser("msie")||this.browser("mozilla"))&&"LI"!==d.tagName&&b(d).replaceWith(b(d).html()),f=e.parent(),this.isParentRedactor(f)&&this.nodeTestBlocks(f[0])&&f.replaceWith(f.contents())),
this.browser("mozilla")&&this.$editor.focus();this.selectionRestore();this.sync();this.callback("execCommand",a,c)},indentingIndent:function(){this.indentingStart("indent")},indentingOutdent:function(){this.indentingStart("outdent")},indentingStart:function(a){this.bufferSet();if("indent"===a)if(a=this.getBlock(),this.selectionSave(),a&&"LI"==a.tagName){a=this.getParent();var c=b(a).closest("ol, ul")[0].tagName,d=this.getBlocks();b.each(d,function(a,d){if("LI"==d.tagName){var g=b(d).prev();if(0!=
g.size()&&"LI"==g[0].tagName){var h=g.children("ul, ol");0==h.size()?g.append(b("<"+c+">").append(d)):h.append(d)}}})}else!1===a&&!0===this.opts.linebreaks?(this.exec("formatBlock","blockquote"),d=this.getBlock(),a=b('<div data-tagblock="">').html(b(d).html()),b(d).replaceWith(a),d=this.normalize(b(a).css("margin-left"))+this.opts.indentValue,b(a).css("margin-left",d+"px")):(a=this.getBlocks(),b.each(a,b.proxy(function(a,c){var d=!1;if("TD"!==c.tagName){var d=-1!==b.inArray(c.tagName,this.opts.alignmentTags)?
b(c):b(c).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]),h=this.normalize(d.css("margin-left"))+this.opts.indentValue;d.css("margin-left",h+"px")}},this)));else this.selectionSave(),(a=this.getBlock())&&"LI"==a.tagName?(d=this.getBlocks(),this.insideOutdent(a,0,d)):(a=this.getBlocks(),b.each(a,b.proxy(function(a,c){var d=!1,d=-1!==b.inArray(c.tagName,this.opts.alignmentTags)?b(c):b(c).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]),h=this.normalize(d.css("margin-left"))-
this.opts.indentValue;0>=h?!0===this.opts.linebreaks&&"undefined"!==typeof d.data("tagblock")?d.replaceWith(d.html()):(d.css("margin-left",""),this.removeEmptyAttr(d,"style")):d.css("margin-left",h+"px")},this)));this.selectionRestore();this.sync()},insideOutdent:function(a,c,d){if(a&&"LI"==a.tagName){var e=b(a).parent().parent();0!=e.size()&&"LI"==e[0].tagName?e.after(a):"undefined"!=typeof d[c]?(a=d[c],c++,this.insideOutdent(a,c,d)):this.execCommand("insertunorderedlist")}},alignmentLeft:function(){this.alignmentSet("",
"JustifyLeft")},alignmentRight:function(){this.alignmentSet("right","JustifyRight")},alignmentCenter:function(){this.alignmentSet("center","JustifyCenter")},alignmentJustify:function(){this.alignmentSet("justify","JustifyFull")},alignmentSet:function(a,c){this.bufferSet();if(this.oldIE())return this.document.execCommand(c,!1,!1),!0;this.selectionSave();var d=this.getBlock();if(!d&&this.opts.linebreaks){this.exec("formatBlock","blockquote");var e=this.getBlock(),d=b('<div data-tagblock="">').html(b(e).html());
b(e).replaceWith(d);b(d).css("text-align",a);this.removeEmptyAttr(d,"style");""==a&&"undefined"!==typeof b(d).data("tagblock")&&b(d).replaceWith(b(d).html())}else d=this.getBlocks(),b.each(d,b.proxy(function(c,d){var e=!1;if(e=-1!==b.inArray(d.tagName,this.opts.alignmentTags)?b(d):b(d).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]))e.css("text-align",a),this.removeEmptyAttr(e,"style")},this));this.selectionRestore();this.sync()},cleanEmpty:function(a){var c=this.placeholderStart(a);
if(!1!==c)return c;!1===this.opts.linebreaks&&(""===a?a=this.opts.emptyHtml:-1!==a.search(/^<hr\s?\/?>$/gi)&&(a="<hr>"+this.opts.emptyHtml));return a},cleanConverters:function(a){this.opts.convertDivs&&(a=a.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p$1>$2</p>"));this.opts.paragraphy&&(a=this.cleanParagraphy(a));return a},cleanConvertProtected:function(a){this.opts.templateVars&&(a=a.replace(/\{\{(.*?)\}\}/gi,"\x3c!-- template double $1 --\x3e"),a=a.replace(/\{(.*?)\}/gi,"\x3c!-- template $1 --\x3e"));
a=a.replace(/<script(.*?)>([\w\W]*?)<\/script>/gi,'<title type="text/javascript" style="display: none;" class="redactor-script-tag"$1>$2</title>');a=a.replace(/<style(.*?)>([\w\W]*?)<\/style>/gi,'<section$1 style="display: none;" rel="redactor-style-tag">$2</section>');a=a.replace(/<form(.*?)>([\w\W]*?)<\/form>/gi,'<section$1 rel="redactor-form-tag">$2</section>');return a=this.opts.phpTags?a.replace(/<\?php([\w\W]*?)\?>/gi,'<section style="display: none;" rel="redactor-php-tag">$1</section>'):a.replace(/<\?php([\w\W]*?)\?>/gi,
"")},cleanReConvertProtected:function(a){this.opts.templateVars&&(a=a.replace(/\x3c!-- template double (.*?) --\x3e/gi,"{{$1}}"),a=a.replace(/\x3c!-- template (.*?) --\x3e/gi,"{$1}"));a=a.replace(/<title type="text\/javascript" style="display: none;" class="redactor-script-tag"(.*?)>([\w\W]*?)<\/title>/gi,'<script$1 type="text/javascript">$2\x3c/script>');a=a.replace(/<section(.*?) style="display: none;" rel="redactor-style-tag">([\w\W]*?)<\/section>/gi,"<style$1>$2</style>");a=a.replace(/<section(.*?)rel="redactor-form-tag"(.*?)>([\w\W]*?)<\/section>/gi,
"<form$1$2>$3</form>");this.opts.phpTags&&(a=a.replace(/<section style="display: none;" rel="redactor-php-tag">([\w\W]*?)<\/section>/gi,"<?php\r\n$1\r\n?>"));return a},cleanRemoveSpaces:function(a,c){if(!1!==c){c=[];var d=a.match(/<(pre|style|script|title)(.*?)>([\w\W]*?)<\/(pre|style|script|title)>/gi);null===d&&(d=[]);if(this.opts.phpTags){var e=a.match(/<\?php([\w\W]*?)\?>/gi);e&&(d=b.merge(d,e))}d&&b.each(d,function(b,d){a=a.replace(d,"buffer_"+b);c.push(d)})}a=a.replace(/\n/g," ");a=a.replace(/[\t]*/g,
"");a=a.replace(/\n\s*\n/g,"\n");a=a.replace(/^[\s\n]*/g," ");a=a.replace(/[\s\n]*$/g," ");a=a.replace(/>\s{2,}</g,"> <");a=this.cleanReplacer(a,c);return a=a.replace(/\n\n/g,"\n")},cleanReplacer:function(a,c){if(!1===c)return a;b.each(c,function(c,b){a=a.replace("buffer_"+c,b)});return a},cleanRemoveEmptyTags:function(a){a=a.replace(/<span>([\w\W]*?)<\/span>/gi,"$1");a=a.replace(/[\u200B-\u200D\uFEFF]/g,"");for(var c=["<b>\\s*</b>","<b>&nbsp;</b>","<em>\\s*</em>"],b="<pre></pre> <blockquote>\\s*</blockquote> <dd></dd> <dt></dt> <ul></ul> <ol></ol> <li></li> <table></table> <tr></tr> <span>\\s*<span> <span>&nbsp;<span> <p>\\s*</p> <p></p> <p>&nbsp;</p> <p>\\s*<br>\\s*</p> <div>\\s*</div> <div>\\s*<br>\\s*</div>".split(" "),
b=this.opts.removeEmptyTags?b.concat(c):c,c=b.length,e=0;e<c;++e)a=a.replace(RegExp(b[e],"gi"),"");return a},cleanParagraphy:function(a){function c(c,b,d){return a.replace(RegExp(c,b),d)}a=b.trim(a);if(!0===this.opts.linebreaks)return a;if(""===a||"<p></p>"===a)return this.opts.emptyHtml;a+="\n";var d=[],e=a.match(/<(table|div|pre|object)(.*?)>([\w\W]*?)<\/(table|div|pre|object)>/gi);e||(e=[]);var f=a.match(/\x3c!--([\w\W]*?)--\x3e/gi);f&&(e=b.merge(e,f));this.opts.phpTags&&(f=a.match(/<section(.*?)rel="redactor-php-tag">([\w\W]*?)<\/section>/gi))&&
(e=b.merge(e,f));e&&b.each(e,function(c,b){d[c]=b;a=a.replace(b,"{replace"+c+"}\n")});a=a.replace(/<br \/>\s*<br \/>/gi,"\n\n");a=c("(<(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)[^>]*>)","gi","\n$1");a=c("(</(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)>)",
"gi","$1\n\n");a=c("\r\n","g","\n");a=c("\r","g","\n");a=c("/\n\n+/","g","\n\n");e=a.split(RegExp("\ns*\n","g"),-1);a="";for(var g in e)e.hasOwnProperty(g)&&(a=-1==e[g].search("{replace")?a+("<p>"+e[g].replace(/^\n+|\n+$/g,"")+"</p>"):a+e[g]);a=c("<p>s*</p>","gi","");a=c("<p>([^<]+)</(div|address|form)>","gi","<p>$1</p></$2>");a=c("<p>s*(</?(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)[^>]*>)s*</p>",
"gi","$1");a=c("<p>(<li.+?)</p>","gi","$1");a=c("<p>s*(</?(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)[^>]*>)","gi","$1");a=c("(</?(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)[^>]*>)s*</p>",
"gi","$1");a=c("(</?(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)[^>]*>)s*<br />","gi","$1");a=c("<br />(s*</?(?:p|li|div|dl|dd|dt|th|pre|td|ul|ol)[^>]*>)","gi","$1");a=c("\n</p>","gi","</p>");a=c("<li><p>","gi","<li>");a=c("</p></li>",
"gi","</li>");a=c("</li><p>","gi","</li>");a=c("<p>\t?\n?<p>","gi","<p>");a=c("</dt><p>","gi","</dt>");a=c("</dd><p>","gi","</dd>");a=c("<br></p></blockquote>","gi","</blockquote>");a=c("<p>\t*</p>","gi","");b.each(d,function(c,b){a=a.replace("{replace"+c+"}",b)});return b.trim(a)},cleanConvertInlineTags:function(a,c){var b="strong";"b"===this.opts.boldTag&&(b="b");var e="em";"i"===this.opts.italicTag&&(e="i");a=a.replace(/<span style="font-style: italic;">([\w\W]*?)<\/span>/gi,"<"+e+">$1</"+e+">");
a=a.replace(/<span style="font-weight: bold;">([\w\W]*?)<\/span>/gi,"<"+b+">$1</"+b+">");a="strong"===this.opts.boldTag?a.replace(/<b>([\w\W]*?)<\/b>/gi,"<strong>$1</strong>"):a.replace(/<strong>([\w\W]*?)<\/strong>/gi,"<b>$1</b>");a="em"===this.opts.italicTag?a.replace(/<i>([\w\W]*?)<\/i>/gi,"<em>$1</em>"):a.replace(/<em>([\w\W]*?)<\/em>/gi,"<i>$1</i>");return a=!0!==c?a.replace(/<strike>([\w\W]*?)<\/strike>/gi,"<del>$1</del>"):a.replace(/<del>([\w\W]*?)<\/del>/gi,"<strike>$1</strike>")},cleanStripTags:function(a){if(""==
a||"undefined"==typeof a)return a;var c=!1;!1!==this.opts.allowedTags&&(c=!0);var d=!0===c?this.opts.allowedTags:this.opts.deniedTags;a=a.replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(a,f){return!0===c?"-1"<b.inArray(f.toLowerCase(),d)?a:"":"-1"<b.inArray(f.toLowerCase(),d)?"":a});return a=this.cleanConvertInlineTags(a)},cleanSavePreCode:function(a,c){var d=a.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/gi);null!==d&&b.each(d,b.proxy(function(b,d){var g=d.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/i);
g[3]=g[3].replace(/&nbsp;/g," ");!1!==c&&(g[3]=this.cleanEncodeEntities(g[3]));a=a.replace(d,"<"+g[1]+g[2]+">"+g[3]+"</"+g[1]+">")},this));return a},cleanEncodeEntities:function(a){a=String(a).replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"');return String(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},cleanUnverified:function(){var a=this.$editor.find("li, img, a, b, strong, sub, sup, i, em, u, small, strike, del, span, cite");
a.filter('[style*="background-color: transparent;"][style*="line-height"]').css("background-color","").css("line-height","");a.filter('[style*="background-color: transparent;"]').css("background-color","");a.css("line-height","");b.each(a,b.proxy(function(a,b){this.removeEmptyAttr(b,"style")},this));this.$editor.find('div[style="text-align: -webkit-auto;"]').contents().unwrap()},cleanHtml:function(a){var c=0,b=a.length,e=0,f=null,e=null,g="",h="",g="";for(this.cleanlevel=0;c<b;c++){e=c;if(-1==a.substr(c).indexOf("<")){h+=
a.substr(c);break}for(;e<b&&"<"!=a.charAt(e);)e++;c!=e&&(g=a.substr(c,e-c),g.match(/^\s{2,}$/g)||("\n"==h.charAt(h.length-1)?h+=this.cleanGetTabs():"\n"==g.charAt(0)&&(h+="\n"+this.cleanGetTabs(),g=g.replace(/^\s+/,"")),h+=g),g.match(/\n/)&&(h+="\n"+this.cleanGetTabs()));for(f=e;e<b&&">"!=a.charAt(e);)e++;g=a.substr(f,e-f);c=e;if("!--"==g.substr(1,3)){if(!g.match(/--$/)){for(;"--\x3e"!=a.substr(e,3);)e++;e+=2;g=a.substr(f,e-f);c=e}"\n"!=h.charAt(h.length-1)&&(h+="\n");h+=this.cleanGetTabs();h+=g+
">\n"}else if("!"==g[1])h=this.placeTag(g+">",h);else if("?"==g[1])h+=g+">\n";else if(e=g.match(/^<(script|style|pre)/i)){if(e[1]=e[1].toLowerCase(),g=this.cleanTag(g),h=this.placeTag(g,h),e=String(a.substr(c+1)).toLowerCase().indexOf("</"+e[1]))g=a.substr(c+1,e),c+=e,h+=g}else g=this.cleanTag(g),h=this.placeTag(g,h)}return this.cleanFinish(h)},cleanGetTabs:function(){for(var a="",c=0;c<this.cleanlevel;c++)a+="\t";return a},cleanFinish:function(a){a=a.replace(/\n\s*\n/g,"\n");a=a.replace(/^[\s\n]*/,
"");a=a.replace(/[\s\n]*$/,"");a=a.replace(/<script(.*?)>\n<\/script>/gi,"<script$1>\x3c/script>");this.cleanlevel=0;return a},cleanTag:function(a){var c="";a=a.replace(/\n/g," ");a=a.replace(/\s{2,}/g," ");a=a.replace(/^\s+|\s+$/g," ");var b="";a.match(/\/$/)&&(b="/",a=a.replace(/\/+$/,""));for(var e;e=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(a);)e[2]?c+=e[1].toLowerCase()+"="+e[2]:e[1]&&(c+=e[1].toLowerCase()),c+=" ",a=a.substr(e[0].length);return c.replace(/\s*$/,"")+b+">"},placeTag:function(a,
c){var b=a.match(this.cleannewLevel);if(a.match(this.cleanlineBefore)||b)c=c.replace(/\s*$/,""),c+="\n";b&&"/"==a.charAt(1)&&this.cleanlevel--;"\n"==c.charAt(c.length-1)&&(c+=this.cleanGetTabs());b&&"/"!=a.charAt(1)&&this.cleanlevel++;c+=a;if(a.match(this.cleanlineAfter)||a.match(this.cleannewLevel))c=c.replace(/ *$/,""),c+="\n";return c},formatEmpty:function(a){var c=b.trim(this.$editor.html());if(this.opts.linebreaks)""==c&&(a.preventDefault(),this.$editor.html(""),this.focus());else{var c=c.replace(/<br\s?\/?>/i,
""),d=c.replace(/<p>\s?<\/p>/gi,"");if(""===c||""===d)a.preventDefault(),a=b(this.opts.emptyHtml).get(0),this.$editor.html(a),this.focus()}this.sync()},formatBlocks:function(a){this.bufferSet();var c=this.getBlocks();this.selectionSave();b.each(c,b.proxy(function(c,e){if("LI"!==e.tagName){var f=b(e).parent();"p"===a?"P"===e.tagName&&0!=f.size()&&"BLOCKQUOTE"===f[0].tagName||"BLOCKQUOTE"===e.tagName?this.formatQuote():this.opts.linebreaks||this.formatBlock(a,e):this.formatBlock(a,e)}},this));this.selectionRestore();
this.sync()},formatBlock:function(a,c){!1===c&&(c=this.getBlock());if(!1===c)return!0===this.opts.linebreaks&&this.execCommand("formatblock",a),!0;var d="";"pre"!==a?d=b(c).contents():(d=b(c).html(),""===b.trim(d)&&(d='<span id="selection-marker-1"></span>'));"PRE"===c.tagName&&(a="p");if(!0===this.opts.linebreaks&&"p"===a)b(c).replaceWith(b("<div>").append(d).html()+"<br>");else{var e=this.getParent(),d=b("<"+a+">").append(d);b(c).replaceWith(d);e&&"TD"==e.tagName&&b(d).wrapAll("<td>")}},formatChangeTag:function(a,
c,d){!1!==d&&this.selectionSave();var e=b("<"+c+"/>");b(a).replaceWith(function(){return e.append(b(this).contents())});!1!==d&&this.selectionRestore();return e},formatQuote:function(){this.bufferSet();if(!1===this.opts.linebreaks){this.selectionSave();var a=this.getBlocks(),c=!1,d=a.length;if(a){var e="",f="",g=!1,h=!0;b.each(a,function(a,c){"P"!==c.tagName&&(h=!1)});b.each(a,b.proxy(function(m,l){if("BLOCKQUOTE"===l.tagName)this.formatBlock("p",l,!1);else if("P"===l.tagName)if(c=b(l).parent(),"BLOCKQUOTE"==
c[0].tagName){var p=b(c).children("p").size();1==p?b(c).replaceWith(l):p==d?(g="blockquote",e+=this.outerHtml(l)):(g="html",e+=this.outerHtml(l),0==m?(b(l).addClass("redactor-replaced").empty(),f=this.outerHtml(l)):b(l).remove())}else!1===h||1==a.length?this.formatBlock("blockquote",l,!1):(g="paragraphs",e+=this.outerHtml(l));else"LI"!==l.tagName&&this.formatBlock("blockquote",l,!1)},this));if(g)if("paragraphs"==g)b(a[0]).replaceWith("<blockquote>"+e+"</blockquote>"),b(a).remove();else if("blockquote"==
g)b(c).replaceWith(e);else if("html"==g){var l=this.$editor.html().replace(f,"</blockquote>"+e+"<blockquote>");this.$editor.html(l);this.$editor.find("blockquote").each(function(){""==b.trim(b(this).html())&&b(this).remove()})}}this.selectionRestore()}else{var m=this.getBlock();if("BLOCKQUOTE"===m.tagName){this.selectionSave();var l=b.trim(b(m).html()),p=b.trim(this.getSelectionHtml()),l=l.replace(/<span(.*?)id="selection-marker(.*?)<\/span>/gi,"");l==p?b(m).replaceWith(b(m).html()+"<br>"):(this.inlineFormat("tmp"),
m=this.$editor.find("tmp"),m.empty(),p=this.$editor.html().replace("<tmp></tmp>",'</blockquote><span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"+p+"<blockquote>"),this.$editor.html(p),m.remove(),this.$editor.find("blockquote").each(function(){""==b.trim(b(this).html())&&b(this).remove()}));this.selectionRestore();this.$editor.find("span#selection-marker-1").attr("id",!1)}else p=this.selectionWrap("blockquote"),l=b(p).html(),b.each("ul ol table tr tbody thead tfoot dl".split(" "),
function(a,c){l=l.replace(RegExp("<"+c+"(.*?)>","gi"),"");l=l.replace(RegExp("</"+c+">","gi"),"")}),m=this.opts.blockLevelElements,m.push("td"),b.each(m,function(a,c){l=l.replace(RegExp("<"+c+"(.*?)>","gi"),"");l=l.replace(RegExp("</"+c+">","gi"),"<br>")}),b(p).html(l),this.selectionElement(p),p=b(p).next(),0!=p.size()&&"BR"===p[0].tagName&&p.remove()}this.sync()},blockRemoveAttr:function(a,c){var d=this.getBlocks();b(d).removeAttr(a);this.sync()},blockSetAttr:function(a,c){var d=this.getBlocks();
b(d).attr(a,c);this.sync()},blockRemoveStyle:function(a){var c=this.getBlocks();b(c).css(a,"");this.removeEmptyAttr(c,"style");this.sync()},blockSetStyle:function(a,c){var d=this.getBlocks();b(d).css(a,c);this.sync()},blockRemoveClass:function(a){var c=this.getBlocks();b(c).removeClass(a);this.removeEmptyAttr(c,"class");this.sync()},blockSetClass:function(a){var c=this.getBlocks();b(c).addClass(a);this.sync()},inlineRemoveClass:function(a){this.selectionSave();this.inlineEachNodes(function(c){b(c).removeClass(a);
this.removeEmptyAttr(c,"class")});this.selectionRestore();this.sync()},inlineSetClass:function(a){var c=this.getCurrent();b(c).hasClass(a)||this.inlineMethods("addClass",a)},inlineRemoveStyle:function(a){this.selectionSave();this.inlineEachNodes(function(c){b(c).css(a,"");this.removeEmptyAttr(c,"style")});this.selectionRestore();this.sync()},inlineSetStyle:function(a,c){this.inlineMethods("css",a,c)},inlineRemoveAttr:function(a){this.selectionSave();var c=this.getRange(),d=this.getElement(),e=this.getNodes();
if(c.collapsed||c.startContainer===c.endContainer&&d)e=b(d);b(e).removeAttr(a);this.inlineUnwrapSpan();this.selectionRestore();this.sync()},inlineSetAttr:function(a,c){this.inlineMethods("attr",a,c)},inlineMethods:function(a,c,d){this.bufferSet();this.selectionSave();var e=this.getRange(),f=this.getElement();if(!e.collapsed&&e.startContainer!==e.endContainer||!f||this.nodeTestBlocks(f))this.document.execCommand("fontSize",!1,4),e=this.$editor.find("font"),b.each(e,b.proxy(function(b,e){this.inlineSetMethods(a,
e,c,d)},this));else b(f)[a](c,d);this.selectionRestore();this.sync()},inlineSetMethods:function(a,c,d,e){var f=b(c).parent();f&&"INLINE"===f[0].tagName&&0!=f[0].attributes.length?b(c).replaceWith(b(c).html()):(f=b("<inline>").append(b(c).contents()),b(c).replaceWith(f));b(f)[a](d,e);return f},inlineEachNodes:function(a){var c=this.getRange(),d=this.getElement(),e=this.getNodes(),f;if(c.collapsed||c.startContainer===c.endContainer&&d)e=b(d),f=!0;b.each(e,b.proxy(function(c,d){if(!f&&"INLINE"!==d.tagName){if("INLINE"!==
d.parentNode.tagName||b(d.parentNode).hasClass("redactor_editor"))return;d=d.parentNode}a.call(this,d)},this))},inlineUnwrapSpan:function(){var a=this.$editor.find("inline");b.each(a,b.proxy(function(a,d){var e=b(d);void 0===e.attr("class")&&void 0===e.attr("style")&&e.contents().unwrap()},this))},inlineFormat:function(a){this.selectionSave();this.document.execCommand("fontSize",!1,4);var c=this.$editor.find("font");b.each(c,function(c,e){var f=b("<"+a+"/>").append(b(e).contents());b(e).replaceWith(f)});
this.selectionRestore();this.sync()},inlineRemoveFormat:function(a){this.selectionSave();var c=a.toUpperCase();a=this.getNodes();var d=b(this.getParent()).parent();b.each(a,function(a,b){b.tagName===c&&this.inlineRemoveFormatReplace(b)});d&&d[0].tagName===c&&this.inlineRemoveFormatReplace(d);this.selectionRestore();this.sync()},inlineRemoveFormatReplace:function(a){b(a).replaceWith(b(a).contents())},insertHtml:function(a,c){var d=this.getCurrent(),e=d.parentNode;this.$editor.focus();this.bufferSet();
var f=b("<div>").append(a);a=f.html();a=this.cleanRemoveEmptyTags(a);var f=b("<div>").append(a),g=this.getBlock();if(1==f.contents().length){var h=f.contents()[0].tagName;if("P"!=h&&h==g.tagName||"PRE"==h)a=f.text(),f=b("<div>").append(a)}!this.opts.linebreaks&&1==f.contents().length&&3==f.contents()[0].nodeType&&(2<this.getRangeSelectedNodes().length||!d||"BODY"==d.tagName&&!e||"HTML"==e.tagName)&&(a="<p>"+a+"</p>");a=this.setSpansVerifiedHtml(a);1<f.contents().length&&g||f.contents().is("p, :header, ul, ol, li, div, table, td, blockquote, pre, address, section, header, footer, aside, article")?
this.browser("msie")?this.document.selection.createRange().pasteHTML(a):this.document.execCommand("inserthtml",!1,a):this.insertHtmlAdvanced(a,!1);this.selectall&&this.window.setTimeout(b.proxy(function(){this.opts.linebreaks?this.focusEnd():this.selectionEnd(this.$editor.contents().last())},this),1);this.observeStart();this.setNonEditable();!1!==c&&this.sync()},insertHtmlAdvanced:function(a,c){var b=this.getSelection();if(b.getRangeAt&&b.rangeCount){var e=b.getRangeAt(0);e.deleteContents();var f=
this.document.createElement("div");f.innerHTML=a;for(var g=this.document.createDocumentFragment(),h,l;h=f.firstChild;)l=g.appendChild(h);e.insertNode(g);l&&(e=e.cloneRange(),e.setStartAfter(l),e.collapse(!0),b.removeAllRanges(),b.addRange(e))}!1!==c&&this.sync()},insertBeforeCursor:function(a){a=this.setSpansVerifiedHtml(a);var c=b(a),d=document.createElement("span");d.innerHTML="\u200b";a=this.getRange();a.insertNode(d);a.insertNode(c[0]);a.collapse(!1);c=this.getSelection();c.removeAllRanges();
c.addRange(a);this.sync()},insertText:function(a){var c=b(a);c.length&&(a=c.text());this.$editor.focus();this.browser("msie")?this.document.selection.createRange().pasteHTML(a):this.document.execCommand("inserthtml",!1,a);this.sync()},insertNode:function(a){a=a[0]||a;if("SPAN"==a.tagName){var c=RegExp("<"+a.tagName,"i"),d=a.outerHTML.replace(c,"<inline"),c=RegExp("</"+a.tagName,"i"),d=d.replace(c,"</inline");a=b(d)[0]}c=this.getSelection();c.getRangeAt&&c.rangeCount&&(range=c.getRangeAt(0),range.deleteContents(),
range.insertNode(a),range.setEndAfter(a),range.setStartAfter(a),c.removeAllRanges(),c.addRange(range))},insertNodeToCaretPositionFromPoint:function(a,c){var b,e=a.clientX,f=a.clientY;if(this.document.caretPositionFromPoint)e=this.document.caretPositionFromPoint(e,f),b=this.getRange(),b.setStart(e.offsetNode,e.offset),b.collapse(!0),b.insertNode(c);else if(this.document.caretRangeFromPoint)b=this.document.caretRangeFromPoint(e,f),b.insertNode(c);else if("undefined"!=typeof document.body.createTextRange){b=
this.document.body.createTextRange();b.moveToPoint(e,f);var g=b.duplicate();g.moveToPoint(e,f);b.setEndPoint("EndToEnd",g);b.select()}},insertAfterLastElement:function(a,c){"undefined"!=typeof c&&(a=c);if(this.isEndOfElement()){if(this.opts.linebreaks){var d=b("<div>").append(b.trim(this.$editor.html())).contents();if(this.outerHtml(d.last()[0])!=this.outerHtml(a))return!1}else if(this.$editor.contents().last()[0]!==a)return!1;this.insertingAfterLastElement(a)}},insertingAfterLastElement:function(a){this.bufferSet();
if(!1===this.opts.linebreaks){var c=b(this.opts.emptyHtml);b(a).after(c);this.selectionStart(c)}else c=b('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>",this.document)[0],b(a).after(c),b(c).after(this.opts.invisibleSpace),this.selectionRestore(),this.$editor.find("span#selection-marker-1").removeAttr("id")},insertLineBreak:function(){this.selectionSave();this.$editor.find("#selection-marker-1").before("<br>"+(this.browser("webkit")?this.opts.invisibleSpace:""));this.selectionRestore()},
insertDoubleLineBreak:function(){this.selectionSave();this.$editor.find("#selection-marker-1").before("<br><br>"+(this.browser("webkit")?this.opts.invisibleSpace:""));this.selectionRestore()},replaceLineBreak:function(a){var c=b("<br>"+this.opts.invisibleSpace);b(a).replaceWith(c);this.selectionStart(c)},pasteClean:function(a){a=this.callback("pasteBefore",!1,a);if(this.browser("msie")){var c=b.trim(a);0==c.search(/^<a(.*?)>(.*?)<\/a>$/i)&&(a=a.replace(/^<a(.*?)>(.*?)<\/a>$/i,"$2"))}if(this.opts.pastePlainText)return c=
this.document.createElement("div"),a=a.replace(/<br>|<\/H[1-6]>|<\/p>|<\/div>/gi,"\n"),c.innerHTML=a,a=c.textContent||c.innerText,a=b.trim(a),a=a.replace("\n","<br>"),a=this.cleanParagraphy(a),this.pasteInsert(a),!1;if(this.currentOrParentIs("PRE"))return a=this.pastePre(a),this.pasteInsert(a),!0;a=a.replace(/<p(.*?)class="MsoListParagraphCxSpFirst"([\w\W]*?)<\/p>/gi,"<ul><li$2</li>");a=a.replace(/<p(.*?)class="MsoListParagraphCxSpMiddle"([\w\W]*?)<\/p>/gi,"<li$2</li>");a=a.replace(/<p(.*?)class="MsoListParagraphCxSpLast"([\w\W]*?)<\/p>/gi,
"<li$2</li></ul>");a=a.replace(/<p(.*?)class="MsoListParagraph"([\w\W]*?)<\/p>/gi,"<ul><li$2</li></ul>");a=a.replace(/\u00b7/g,"");a=a.replace(/\x3c!--[\s\S]*?--\x3e|<\?(?:php)?[\s\S]*?\?>/gi,"");a=a.replace(/(&nbsp;){2,}/gi,"&nbsp;");a=a.replace(/&nbsp;/gi," ");a=a.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2");a=a.replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3");a=this.cleanStripTags(a);a=a.replace(/<td><\/td>/gi,"[td]");a=a.replace(/<td>&nbsp;<\/td>/gi,
"[td]");a=a.replace(/<td><br><\/td>/gi,"[td]");a=a.replace(/<td(.*?)colspan="(.*?)"(.*?)>([\w\W]*?)<\/td>/gi,'[td colspan="$2"]$4[/td]');a=a.replace(/<td(.*?)rowspan="(.*?)"(.*?)>([\w\W]*?)<\/td>/gi,'[td rowspan="$2"]$4[/td]');a=a.replace(/<a(.*?)href="(.*?)"(.*?)>([\w\W]*?)<\/a>/gi,'[a href="$2"]$4[/a]');a=a.replace(/<iframe(.*?)>([\w\W]*?)<\/iframe>/gi,"[iframe$1]$2[/iframe]");a=a.replace(/<video(.*?)>([\w\W]*?)<\/video>/gi,"[video$1]$2[/video]");a=a.replace(/<audio(.*?)>([\w\W]*?)<\/audio>/gi,
"[audio$1]$2[/audio]");a=a.replace(/<embed(.*?)>([\w\W]*?)<\/embed>/gi,"[embed$1]$2[/embed]");a=a.replace(/<object(.*?)>([\w\W]*?)<\/object>/gi,"[object$1]$2[/object]");a=a.replace(/<param(.*?)>/gi,"[param$1]");a=a.replace(/<img(.*?)>/gi,"[img$1]");a=a.replace(/ class="(.*?)"/gi,"");a=a.replace(/<(\w+)([\w\W]*?)>/gi,"<$1>");a=a.replace(/<[^\/>][^>]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,"");a=a.replace(/<div>\s*?\t*?\n*?(<ul>|<ol>|<p>)/gi,"$1");a=a.replace(/\[td colspan="(.*?)"\]([\w\W]*?)\[\/td\]/gi,
'<td colspan="$1">$2</td>');a=a.replace(/\[td rowspan="(.*?)"\]([\w\W]*?)\[\/td\]/gi,'<td rowspan="$1">$2</td>');a=a.replace(/\[td\]/gi,"<td>&nbsp;</td>");a=a.replace(/\[a href="(.*?)"\]([\w\W]*?)\[\/a\]/gi,'<a href="$1">$2</a>');a=a.replace(/\[iframe(.*?)\]([\w\W]*?)\[\/iframe\]/gi,"<iframe$1>$2</iframe>");a=a.replace(/\[video(.*?)\]([\w\W]*?)\[\/video\]/gi,"<video$1>$2</video>");a=a.replace(/\[audio(.*?)\]([\w\W]*?)\[\/audio\]/gi,"<audio$1>$2</audio>");a=a.replace(/\[embed(.*?)\]([\w\W]*?)\[\/embed\]/gi,
"<embed$1>$2</embed>");a=a.replace(/\[object(.*?)\]([\w\W]*?)\[\/object\]/gi,"<object$1>$2</object>");a=a.replace(/\[param(.*?)\]/gi,"<param$1>");a=a.replace(/\[img(.*?)\]/gi,"<img$1>");this.opts.convertDivs&&(a=a.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p>$2</p>"),a=a.replace(/<\/div><p>/gi,"<p>"),a=a.replace(/<\/p><\/div>/gi,"</p>"));a=this.currentOrParentIs("LI")?a.replace(/<p>([\w\W]*?)<\/p>/gi,"$1<br>"):this.cleanParagraphy(a);a=a.replace(/<span(.*?)>([\w\W]*?)<\/span>/gi,"$2");a=a.replace(/<img>/gi,
"");a=a.replace(/<[^\/>][^>][^img|param|source]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,"");a=a.replace(/\n{3,}/gi,"\n");a=a.replace(/<p><p>/gi,"<p>");a=a.replace(/<\/p><\/p>/gi,"</p>");a=a.replace(/<li>(\s*|\t*|\n*)<p>/gi,"<li>");a=a.replace(/<\/p>(\s*|\t*|\n*)<\/li>/gi,"</li>");!0===this.opts.linebreaks&&(a=a.replace(/<p(.*?)>([\w\W]*?)<\/p>/gi,"$2<br>"));a=a.replace(/<[^\/>][^>][^img|param|source]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,"");a=a.replace(/<img src="webkit-fake-url\:\/\/(.*?)"(.*?)>/gi,
"");a=a.replace(/<td(.*?)>(\s*|\t*|\n*)<p>([\w\W]*?)<\/p>(\s*|\t*|\n*)<\/td>/gi,"<td$1>$3</td>");a=a.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"$2");a=a.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"$2");this.pasteClipboardMozilla=!1;if(this.browser("mozilla")){if(this.opts.clipboardUpload&&(c=a.match(/<img src="data:image(.*?)"(.*?)>/gi),null!==c))for(k in this.pasteClipboardMozilla=c,c){var d=c[k].replace("<img",'<img data-mozilla-paste-image="'+k+'" ');a=a.replace(c[k],d)}for(;/<br>$/gi.test(a);)a=a.replace(/<br>$/gi,
"")}for(a=a.replace(/<p>\u2022([\w\W]*?)<\/p>/gi,"<li>$1</li>");/<font>([\w\W]*?)<\/font>/gi.test(a);)a=a.replace(/<font>([\w\W]*?)<\/font>/gi,"$1");this.pasteInsert(a)},pastePre:function(a){a=a.replace(/<br>|<\/H[1-6]>|<\/p>|<\/div>/gi,"\n");var c=this.document.createElement("div");c.innerHTML=a;return this.cleanEncodeEntities(c.textContent||c.innerText)},pasteInsert:function(a){this.selectall&&(this.opts.linebreaks?this.$editor.html(""):this.$editor.html(this.opts.emptyHtml),this.$editor.focus());
a=this.callback("pasteAfter",!1,a);this.insertHtml(a);this.selectall=!1;setTimeout(b.proxy(function(){this.rtePaste=!1;this.browser("mozilla")&&this.$editor.find("p:empty").remove();!1!==this.pasteClipboardMozilla&&this.pasteClipboardUploadMozilla()},this),100);this.opts.autoresize&&!0!==this.fullscreen?b(this.document.body).scrollTop(this.saveScroll):this.$editor.scrollTop(this.saveScroll)},pasteClipboardUploadMozilla:function(){var a=this.$editor.find("img[data-mozilla-paste-image]");b.each(a,b.proxy(function(a,
d){var e=b(d),f=d.src.split(","),g=f[1],f=f[0].split(";")[0].split(":")[1];b.post(this.opts.clipboardUploadUrl,{contentType:f,data:g},b.proxy(function(a){a="string"===typeof a?b.parseJSON(a):a;e.attr("src",a.filelink);e.removeAttr("data-mozilla-paste-image");this.sync();this.callback("imageUpload",e,a)},this))},this))},pasteClipboardUpload:function(a){a=a.target.result;var c=a.split(","),d=c[1],c=c[0].split(";")[0].split(":")[1];this.opts.clipboardUpload?b.post(this.opts.clipboardUploadUrl,{contentType:c,
data:d},b.proxy(function(a){a="string"===typeof a?b.parseJSON(a):a;this.execCommand("inserthtml",'<img src="'+a.filelink+'" id="clipboard-image-marker" />',!1);var c=b(this.$editor.find("img#clipboard-image-marker"));c.length?c.removeAttr("id"):c=!1;this.sync();c&&this.callback("imageUpload",c,a)},this)):this.insertHtml('<img src="'+a+'" />')},bufferSet:function(a){void 0!==a?this.opts.buffer.push(a):(this.selectionSave(),this.opts.buffer.push(this.$editor.html()),this.selectionRemoveMarkers("buffer"))},
bufferUndo:function(){0===this.opts.buffer.length?this.$editor.focus():(this.selectionSave(),this.opts.rebuffer.push(this.$editor.html()),this.selectionRestore(!1,!0),this.$editor.html(this.opts.buffer.pop()),this.selectionRestore(),setTimeout(b.proxy(this.observeStart,this),100))},bufferRedo:function(){if(0===this.opts.rebuffer.length)return this.$editor.focus(),!1;this.selectionSave();this.opts.buffer.push(this.$editor.html());this.selectionRestore(!1,!0);this.$editor.html(this.opts.rebuffer.pop());
this.selectionRestore(!0);setTimeout(b.proxy(this.observeStart,this),4)},observeStart:function(){this.observeImages();this.opts.observeLinks&&this.observeLinks()},observeLinks:function(){this.$editor.find("a").on("click",b.proxy(this.linkObserver,this));this.$editor.on("click.redactor",b.proxy(function(a){this.linkObserverTooltipClose(a)},this))},observeImages:function(){if(!1===this.opts.observeImages)return!1;this.$editor.find("img").each(b.proxy(function(a,c){this.browser("msie")&&b(c).attr("unselectable",
"on");this.imageResize(c)},this))},linkObserver:function(a){var c=b(a.target);a=c.offset();if(this.opts.iframe){var d=this.$frame.offset();a.top=d.top+(a.top-b(this.document).scrollTop());a.left+=d.left}var d=b('<span class="redactor-link-tooltip"></span>'),e=c.attr("href");24<e.length&&(e=e.substring(0,24)+"...");var c=b('<a href="'+c.attr("href")+'" target="_blank">'+e+"</a>").on("click",b.proxy(function(a){this.linkObserverTooltipClose(!1)},this)),e=b('<a href="#">'+this.opts.curLang.edit+"</a>").on("click",
b.proxy(function(a){a.preventDefault();this.linkShow();this.linkObserverTooltipClose(!1)},this)),f=b('<a href="#">'+this.opts.curLang.unlink+"</a>").on("click",b.proxy(function(a){a.preventDefault();this.execCommand("unlink");this.linkObserverTooltipClose(!1)},this));d.append(c);d.append(" | ");d.append(e);d.append(" | ");d.append(f);d.css({top:a.top+20+"px",left:a.left+"px"});b(".redactor-link-tooltip").remove();b("body").append(d)},linkObserverTooltipClose:function(a){if(!1!==a&&"A"==a.target.tagName)return!1;
b(".redactor-link-tooltip").remove()},getSelection:function(){return this.opts.rangy?this.opts.iframe?rangy.getSelection(this.$frame[0]):rangy.getSelection():this.document.getSelection()},getRange:function(){if(this.opts.rangy)return this.opts.iframe?rangy.createRange(this.iframeDoc()):rangy.createRange();if(this.document.getSelection){var a=this.getSelection();if(a.getRangeAt&&a.rangeCount)return a.getRangeAt(0)}return this.document.createRange()},selectionElement:function(a){this.setCaret(a)},selectionStart:function(a){this.selectionSet(a[0]||
a,0,null,0)},selectionEnd:function(a){this.selectionSet(a[0]||a,1,null,1)},selectionSet:function(a,c,b,e){null==b&&(b=a);null==e&&(e=c);var f=this.getSelection();if(f){var g=this.getRange();g.setStart(a,c);g.setEnd(b,e);try{f.removeAllRanges()}catch(h){}f.addRange(g)}},selectionWrap:function(a){a=a.toLowerCase();var c=this.getBlock();if(c)return a=this.formatChangeTag(c,a),this.sync(),a;c=this.getSelection().getRangeAt(0);a=document.createElement(a);a.appendChild(c.extractContents());c.insertNode(a);
this.selectionElement(a);return a},selectionAll:function(){var a=this.getRange();a.selectNodeContents(this.$editor[0]);var c=this.getSelection();c.removeAllRanges();c.addRange(a)},selectionRemove:function(){this.getSelection().removeAllRanges()},getCaretOffset:function(a){var c=0,c=this.getRange(),d=c.cloneRange();d.selectNodeContents(a);d.setEnd(c.endContainer,c.endOffset);return c=b.trim(d.toString()).length},getCaretOffsetRange:function(){return new t(this.getSelection().getRangeAt(0))},setCaret:function(a,
c,b){"undefined"===typeof b&&(b=c);a=a[0]||a;var e=this.getRange();e.selectNodeContents(a);a=this.getTextNodesIn(a);var f=!1,g=0,h;if(1==a.length&&c)e.setStart(a[0],c),e.setEnd(a[0],b);else for(var l=0,m;m=a[l++];){h=g+m.length;!f&&c>=g&&(c<h||c==h&&l<a.length)&&(e.setStart(m,c-g),f=!0);if(f&&b<=h){e.setEnd(m,b-g);break}g=h}c=this.getSelection();c.removeAllRanges();c.addRange(e)},getTextNodesIn:function(a){var c=[];if(3==a.nodeType)c.push(a);else{a=a.childNodes;for(var b=0,e=a.length;b<e;++b)c.push.apply(c,
this.getTextNodesIn(a[b]))}return c},getCurrent:function(){var a=!1,c=this.getSelection();0<c.rangeCount&&(a=c.getRangeAt(0).startContainer);return this.isParentRedactor(a)},getParent:function(a){return(a=a||this.getCurrent())?this.isParentRedactor(b(a).parent()[0]):!1},getBlock:function(a){for("undefined"===typeof a&&(a=this.getCurrent());a;){if(this.nodeTestBlocks(a)){if(b(a).hasClass("redactor_editor"))break;return a}a=a.parentNode}return!1},getBlocks:function(a){var c=[];if("undefined"==typeof a){if((a=
this.getRange())&&!0===a.collapsed)return[this.getBlock()];a=this.getNodes(a)}b.each(a,b.proxy(function(a,e){if(!1===this.opts.iframe&&0==b(e).parents("div.redactor_editor").size())return!1;this.nodeTestBlocks(e)&&c.push(e)},this));0===c.length&&(c=[this.getBlock()]);return c},nodeTestBlocks:function(a){return 1==a.nodeType&&this.rTestBlock.test(a.nodeName)},tagTestBlock:function(a){return this.rTestBlock.test(a)},getNodes:function(a,c){if("undefined"==typeof a||!1==a)a=this.getRange();if(a&&!0===
a.collapsed){if("undefined"===typeof c&&this.tagTestBlock(c)){var d=this.getBlock();return d.tagName==c?[d]:[]}return[this.getCurrent()]}var d=[],e=[],f=this.document.getSelection();f.isCollapsed||(d=this.getRangeSelectedNodes(f.getRangeAt(0)));b.each(d,b.proxy(function(a,d){if(!1===this.opts.iframe&&0==b(d).parents("div.redactor_editor").size())return!1;"undefined"===typeof c?""!=b.trim(d.textContent)&&e.push(d):d.tagName==c&&e.push(d)},this));if(0==e.length){if("undefined"===typeof c&&this.tagTestBlock(c))return d=
this.getBlock(),d.tagName==c?e.push(d):[];e.push(this.getCurrent())}this.nodeTestBlocks(e[e.length-1])&&(e=e.slice(0,-1));return e},getElement:function(a){for(a||(a=this.getCurrent());a;){if(1==a.nodeType){if(b(a).hasClass("redactor_editor"))break;return a}a=a.parentNode}return!1},getRangeSelectedNodes:function(a){a=a||this.getRange();var c=a.startContainer,b=a.endContainer;if(c==b)return[c];for(var e=[];c&&c!=b;)e.push(c=this.nextNode(c));for(c=a.startContainer;c&&c!=a.commonAncestorContainer;)e.unshift(c),
c=c.parentNode;return e},nextNode:function(a){if(a.hasChildNodes())return a.firstChild;for(;a&&!a.nextSibling;)a=a.parentNode;return a?a.nextSibling:null},getSelectionText:function(){return this.getSelection().toString()},getSelectionHtml:function(){var a="",c=this.getSelection();if(c.rangeCount){for(var a=this.document.createElement("div"),b=c.rangeCount,e=0;e<b;++e)a.appendChild(c.getRangeAt(e).cloneContents());a=a.innerHTML}return this.syncClean(a)},selectionSave:function(){this.isFocused()||this.$editor.focus();
this.opts.rangy?this.savedSel=rangy.saveSelection():this.selectionCreateMarker(this.getRange())},selectionCreateMarker:function(a,c){if(a){var d=b('<span id="selection-marker-1" class="redactor-selection-marker">'+this.opts.invisibleSpace+"</span>",this.document)[0],e=b('<span id="selection-marker-2" class="redactor-selection-marker">'+this.opts.invisibleSpace+"</span>",this.document)[0];!0===a.collapsed?this.selectionSetMarker(a,d,!0):(this.selectionSetMarker(a,d,!0),this.selectionSetMarker(a,e,
!1));this.savedSel=this.$editor.html();this.selectionRestore(!1,!1)}},selectionSetMarker:function(a,c,b){a=a.cloneRange();a.collapse(b);a.insertNode(c);a.detach()},selectionRestore:function(a,c){if(this.opts.rangy)rangy.restoreSelection(this.savedSel);else{!0===a&&this.savedSel&&this.$editor.html(this.savedSel);var b=this.$editor.find("span#selection-marker-1"),e=this.$editor.find("span#selection-marker-2");this.browser("mozilla")?this.$editor.focus():this.isFocused()||this.$editor.focus();0!=b.length&&
0!=e.length?this.selectionSet(b[0],0,e[0],0):0!=b.length&&this.selectionSet(b[0],0,null,0);!1!==c&&(this.selectionRemoveMarkers(),this.savedSel=!1)}},selectionRemoveMarkers:function(a){this.opts.rangy?rangy.removeMarkers(this.savedSel):b.each(this.$editor.find("span.redactor-selection-marker"),function(){""==b.trim(b(this).html().replace(/[^\u0000-\u1C7F]/g,""))?b(this).remove():b(this).removeAttr("class").removeAttr("id")})},tableShow:function(){this.selectionSave();this.modalInit(this.opts.curLang.table,
this.opts.modal_table,300,b.proxy(function(){b("#redactor_insert_table_btn").click(b.proxy(this.tableInsert,this));setTimeout(function(){b("#redactor_table_rows").focus()},200)},this))},tableInsert:function(){var a=b("#redactor_table_rows").val(),c=b("#redactor_table_columns").val(),d=b("<div></div>"),e=Math.floor(99999*Math.random()),f=b('<table id="table'+e+'"><tbody></tbody></table>'),g,h,l,m;for(g=0;g<a;g++){h=b("<tr></tr>");for(l=0;l<c;l++)m=b("<td>"+this.opts.invisibleSpace+"</td>"),0===g&&
0===l&&m.append('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"),b(h).append(m);f.append(h)}d.append(f);a=d.html();this.modalClose();this.selectionRestore();(c=this.getBlock()||this.getCurrent())&&"BODY"!=c.tagName?b(c).after(a):this.insertHtmlAdvanced(a,!1);this.selectionRestore();e=this.$editor.find("#table"+e);this.buttonActiveObserver();e.find("span#selection-marker-1").remove();e.removeAttr("id");this.sync()},tableDeleteTable:function(){var a=b(this.getParent()).closest("table");
if(!this.isParentRedactor(a)||0==a.size())return!1;this.bufferSet();a.remove();this.sync()},tableDeleteRow:function(){var a=b(this.getParent()).closest("table");if(!this.isParentRedactor(a)||0==a.size())return!1;this.bufferSet();var a=b(this.getParent()).closest("tr"),c=a.prev().length?a.prev():a.next();c.length&&(c=c.children("td").first(),c.length&&c.prepend('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"));a.remove();this.selectionRestore();this.sync()},tableDeleteColumn:function(){var a=
b(this.getParent()).closest("table");if(!this.isParentRedactor(a)||0==a.size())return!1;this.bufferSet();var c=b(this.getParent()).closest("td").get(0).cellIndex;a.find("tr").each(b.proxy(function(a,e){var f=0>c-1?c+1:c-1;0===a&&b(e).find("td").eq(f).prepend('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>");b(e).find("td").eq(c).remove()},this));this.selectionRestore();this.sync()},tableAddHead:function(){var a=b(this.getParent()).closest("table");if(!this.isParentRedactor(a)||
0==a.size())return!1;this.bufferSet();if(0!==a.find("thead").size())this.tableDeleteHead();else{var c=a.find("tr").first().clone();c.find("td").html(this.opts.invisibleSpace);$thead=b("<thead></thead>");$thead.append(c);a.prepend($thead);this.sync()}},tableDeleteHead:function(){var a=b(this.getParent()).closest("table");if(!this.isParentRedactor(a))return!1;a=a.find("thead");if(0==a.size())return!1;this.bufferSet();a.remove();this.sync()},tableAddRowAbove:function(){this.tableAddRow("before")},tableAddRowBelow:function(){this.tableAddRow("after")},
tableAddColumnLeft:function(){this.tableAddColumn("before")},tableAddColumnRight:function(){this.tableAddColumn("after")},tableAddRow:function(a){var c=b(this.getParent()).closest("table");if(!this.isParentRedactor(c)||0==c.size())return!1;this.bufferSet();var c=b(this.getParent()).closest("tr"),d=c.clone();d.find("td").html(this.opts.invisibleSpace);"after"===a?c.after(d):c.before(d);this.sync()},tableAddColumn:function(a){var c=b(this.getParent()).closest("table");if(!this.isParentRedactor(c)||
0==c.size())return!1;this.bufferSet();var d=0,e=b(this.getParent()).closest("tr"),f=b(this.getParent()).closest("td");e.find("td").each(b.proxy(function(a,c){b(c)[0]===f[0]&&(d=a)},this));c.find("tr").each(b.proxy(function(c,e){var f=b(e).find("td").eq(d),m=f.clone();m.html(this.opts.invisibleSpace);"after"===a?f.after(m):f.before(m)},this));this.sync()},videoShow:function(){this.selectionSave();this.modalInit(this.opts.curLang.video,this.opts.modal_video,600,b.proxy(function(){b("#redactor_insert_video_btn").click(b.proxy(this.videoInsert,
this));setTimeout(function(){b("#redactor_insert_video_area").focus()},200)},this))},videoInsert:function(){var a=b("#redactor_insert_video_area").val(),a=this.cleanStripTags(a);this.selectionRestore();var c=this.getBlock()||this.getCurrent();c?b(c).after(a):this.insertHtmlAdvanced(a,!1);this.sync();this.modalClose()},linkShow:function(){this.selectionSave();var a=b.proxy(function(){this.insert_link_node=!1;var a=this.getSelection(),d="",e="",f="",g=this.getParent();(e=b(g).parent().get(0))&&"A"===
e.tagName&&(g=e);g&&"A"===g.tagName?(d=g.href,e=b(g).text(),f=g.target,this.insert_link_node=g):e=a.toString();b(".redactor_link_text").val(e);a=self.location.href.replace(/\/$/i,"");a=d.replace(a,"");!1===this.opts.linkProtocol&&(a=a.replace(RegExp("^(http|ftp|https)://"+self.location.host,"i"),""));g=b("#redactor_tabs").find("a");!1===this.opts.linkEmail&&g.eq(1).remove();!1===this.opts.linkAnchor&&g.eq(2).remove();!1===this.opts.linkEmail&&!1===this.opts.linkAnchor?(b("#redactor_tabs").remove(),
b("#redactor_link_url").val(a)):0===d.search("mailto:")?(this.modalSetTab.call(this,2),b("#redactor_tab_selected").val(2),b("#redactor_link_mailto").val(d.replace("mailto:",""))):0===a.search(/^#/gi)?(this.modalSetTab.call(this,3),b("#redactor_tab_selected").val(3),b("#redactor_link_anchor").val(a.replace(/^#/gi,""))):b("#redactor_link_url").val(a);"_blank"===f&&b("#redactor_link_blank").prop("checked",!0);b("#redactor_insert_link_btn").click(b.proxy(this.linkProcess,this));setTimeout(function(){b("#redactor_link_url").focus()},
200)},this);this.modalInit(this.opts.curLang.link,this.opts.modal_link,460,a)},linkProcess:function(){var a=b("#redactor_tab_selected").val(),c="",d="",e="",f="";"1"===a?(c=b("#redactor_link_url").val(),d=b("#redactor_link_url_text").val(),b("#redactor_link_blank").prop("checked")&&(e=' target="_blank"',f="_blank"),a=/^((xn--)?[a-z0-9]+(-[a-z0-9]+)*.)+[a-z]{2,}/i,-1==c.search(/^(http|ftp|https):\/\/((xn--)?[a-z0-9]+(-[a-z0-9]+)*.)+[a-z]{2,}/i)&&0==c.search(a)&&this.opts.linkProtocol&&(c=this.opts.linkProtocol+
c)):"2"===a?(c="mailto:"+b("#redactor_link_mailto").val(),d=b("#redactor_link_mailto_text").val()):"3"===a&&(c="#"+b("#redactor_link_anchor").val(),d=b("#redactor_link_anchor_text").val());d=d.replace(/<|>/g,"");this.linkInsert('<a href="'+c+'"'+e+">"+d+"</a>",b.trim(d),c,f)},linkInsert:function(a,c,d,e){this.selectionRestore();""!==c&&(this.insert_link_node?(this.bufferSet(),b(this.insert_link_node).text(c).attr("href",d),""!==e?b(this.insert_link_node).attr("target",e):b(this.insert_link_node).removeAttr("target"),
this.sync()):this.exec("inserthtml",a));setTimeout(b.proxy(function(){this.opts.observeLinks&&this.observeLinks()},this),5);this.modalClose()},fileShow:function(){this.selectionSave();var a=b.proxy(function(){var a=this.getSelection(),d="",d=this.oldIE()?a.text:a.toString();b("#redactor_filename").val(d);this.isMobile()||this.draguploadInit("#redactor_file",{url:this.opts.fileUpload,uploadFields:this.opts.uploadFields,success:b.proxy(this.fileCallback,this),error:b.proxy(function(a,b){this.callback("fileUploadError",
b)},this),uploadParam:this.opts.fileUploadParam});this.uploadInit("redactor_file",{auto:!0,url:this.opts.fileUpload,success:b.proxy(this.fileCallback,this),error:b.proxy(function(a,b){this.callback("fileUploadError",b)},this)})},this);this.modalInit(this.opts.curLang.file,this.opts.modal_file,500,a)},fileCallback:function(a){this.selectionRestore();if(!1!==a){var c=b("#redactor_filename").val();""===c&&(c=a.filename);c='<a href="'+a.filelink+'" id="filelink-marker">'+c+"</a>";this.browser("webkit")&&
this.window.chrome&&(c+="&nbsp;");this.execCommand("inserthtml",c,!1);c=b(this.$editor.find("a#filelink-marker"));0!=c.size()?c.removeAttr("id"):c=!1;this.sync();this.callback("fileUpload",c,a)}this.modalClose()},imageShow:function(){this.selectionSave();var a=b.proxy(function(){this.opts.imageGetJson?b.getJSON(this.opts.imageGetJson,b.proxy(function(a){var c={},f=0;b.each(a,b.proxy(function(a,b){"undefined"!==typeof b.folder&&(f++,c[b.folder]=f)},this));var g=!1;b.each(a,b.proxy(function(a,d){var f=
"";"undefined"!==typeof d.title&&(f=d.title);var h=0;b.isEmptyObject(c)||"undefined"===typeof d.folder||(h=c[d.folder],!1===g&&(g=".redactorfolder"+h));f=b('<img src="'+d.thumb+'" class="redactorfolder redactorfolder'+h+'" rel="'+d.image+'" title="'+f+'" />');b("#redactor_image_box").append(f);b(f).click(b.proxy(this.imageThumbClick,this))},this));if(!b.isEmptyObject(c)){b(".redactorfolder").hide();b(g).show();var h=b('<select id="redactor_image_box_select">');b.each(c,function(a,c){h.append(b('<option value="'+
c+'">'+a+"</option>"))});b("#redactor_image_box").before(h);h.change(function(a){b(".redactorfolder").hide();b(".redactorfolder"+b(a.target).val()).show()})}},this)):b("#redactor_tabs").find("a").eq(1).remove();if(this.opts.imageUpload||this.opts.s3)if(this.isMobile()||!1!==this.opts.s3||b("#redactor_file").length&&this.draguploadInit("#redactor_file",{url:this.opts.imageUpload,uploadFields:this.opts.uploadFields,success:b.proxy(this.imageCallback,this),error:b.proxy(function(a,b){this.callback("imageUploadError",
b)},this),uploadParam:this.opts.imageUploadParam}),!1===this.opts.s3)this.uploadInit("redactor_file",{auto:!0,url:this.opts.imageUpload,success:b.proxy(this.imageCallback,this),error:b.proxy(function(a,b){this.callback("imageUploadError",b)},this)});else b("#redactor_file").on("change.redactor",b.proxy(this.s3handleFileSelect,this));else if(b(".redactor_tab").hide(),this.opts.imageGetJson){var a=b("#redactor_tabs").find("a");a.eq(0).remove();a.eq(1).addClass("redactor_tabs_act");b("#redactor_tab2").show()}else b("#redactor_tabs").remove(),
b("#redactor_tab3").show();b("#redactor_upload_btn").click(b.proxy(this.imageCallbackLink,this));this.opts.imageUpload||this.opts.imageGetJson||setTimeout(function(){b("#redactor_file_link").focus()},200)},this);this.modalInit(this.opts.curLang.image,this.opts.modal_image,610,a)},imageEdit:function(a){var c=a.parent().parent(),d=b.proxy(function(){b("#redactor_file_alt").val(a.attr("alt"));b("#redactor_image_edit_src").attr("href",a.attr("src"));b("#redactor_form_image_align").val(a.css("float"));
"A"===b(c).get(0).tagName&&(b("#redactor_file_link").val(b(c).attr("href")),"_blank"==b(c).attr("target")&&b("#redactor_link_blank").prop("checked",!0));b("#redactor_image_delete_btn").click(b.proxy(function(){this.imageRemove(a)},this));b("#redactorSaveBtn").click(b.proxy(function(){this.imageSave(a)},this))},this);this.modalInit(this.opts.curLang.edit,this.opts.modal_image_edit,380,d)},imageRemove:function(a){var c=b(a).parent();b(a).remove();c.length&&"P"===c[0].tagName&&(this.$editor.focus(),
this.selectionStart(c));this.callback("imageDelete",a);this.modalClose();this.sync()},imageSave:function(a){var c=b(a),d=c.parent();c.attr("alt",b("#redactor_file_alt").val());var e=b("#redactor_form_image_align").val();"left"===e?(this.imageMargin="0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin+" 0",c.css({"float":"left",margin:this.imageMargin})):"right"===e?(this.imageMargin="0 0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin+"",c.css({"float":"right",margin:this.imageMargin})):
(this.imageMargin="0px",e=c.closest("#redactor-image-box"),0!=e.size()&&e.css({"float":"",margin:""}),c.css({"float":"",margin:""}));var f=b.trim(b("#redactor_file_link").val());""!==f?(e=!1,b("#redactor_link_blank").prop("checked")&&(e=!0),"A"!==d.get(0).tagName?(a=b('<a href="'+f+'">'+this.outerHtml(a)+"</a>"),e&&a.attr("target","_blank"),c.replaceWith(a)):(d.attr("href",f),e?d.attr("target","_blank"):d.removeAttr("target"))):"A"===d.get(0).tagName&&d.replaceWith(this.outerHtml(a));this.modalClose();
this.observeImages();this.sync()},imageResizeHide:function(a){if(!1!==a&&0!=b(a.target).parent().size()&&"redactor-image-box"===b(a.target).parent()[0].id)return!1;a=this.$editor.find("#redactor-image-box");if(0==a.size())return!1;this.$editor.find("#redactor-image-editter, #redactor-image-resizer").remove();"0px"!=this.imageMargin&&(a.find("img").css("margin",this.imageMargin),a.css("margin",""),this.imageMargin="0px");a.find("img").css("opacity","");a.replaceWith(function(){return b(this).contents()});
b(document).off("click.redactor-image-resize-hide");this.$editor.off("click.redactor-image-resize-hide");this.$editor.off("keydown.redactor-image-delete");this.sync()},imageResize:function(a){var c=b(a);c.on("mousedown",b.proxy(function(){this.imageResizeHide(!1)},this));c.on("dragstart",b.proxy(function(){this.$editor.on("drop.redactor-image-inside-drop",b.proxy(function(){setTimeout(b.proxy(function(){this.observeImages();this.$editor.off("drop.redactor-image-inside-drop");this.sync()},this),1)},
this))},this));c.on("click",b.proxy(function(a){if(0!=this.$editor.find("#redactor-image-box").size())return!1;var e,f=c.width()/c.height(),g=!1;this.imageResizeControls(c).on("mousedown",function(a){g=!0;a.preventDefault();f=c.width()/c.height();Math.round(a.pageX-c.eq(0).offset().left);e=Math.round(a.pageY-c.eq(0).offset().top)});b(this.document.body).on("mousemove",b.proxy(function(a){if(g){Math.round(a.pageX-c.eq(0).offset().left);var b=Math.round(a.pageY-c.eq(0).offset().top)-e,d=c.height(),
b=parseInt(d,10)+b,b=Math.round(b*f);20<b&&(c.width(b),100>b?this.imageEditter.css({marginTop:"-7px",marginLeft:"-13px",fontSize:"9px",padding:"3px 5px"}):this.imageEditter.css({marginTop:"-11px",marginLeft:"-18px",fontSize:"11px",padding:"7px 10px"}));Math.round(a.pageX-c.eq(0).offset().left);e=Math.round(a.pageY-c.eq(0).offset().top);this.sync()}},this)).on("mouseup",function(){g=!1});this.$editor.on("keydown.redactor-image-delete",b.proxy(function(a){a=a.which;if(this.keyCode.BACKSPACE==a||this.keyCode.DELETE==
a)this.bufferSet(),this.imageResizeHide(!1),this.imageRemove(c)},this));b(document).on("click.redactor-image-resize-hide",b.proxy(this.imageResizeHide,this));this.$editor.on("click.redactor-image-resize-hide",b.proxy(this.imageResizeHide,this))},this))},imageResizeControls:function(a){var c=b('<span id="redactor-image-box" data-redactor="verified">');c.css({position:"relative",display:"inline-block",lineHeight:0,outline:"1px dashed rgba(0, 0, 0, .6)","float":a.css("float")});c.attr("contenteditable",
!1);this.imageMargin=a[0].style.margin;"0px"!=this.imageMargin&&(c.css("margin",this.imageMargin),a.css("margin",""));a.css("opacity",0.5).after(c);this.imageEditter=b('<span id="redactor-image-editter" data-redactor="verified">'+this.opts.curLang.edit+"</span>");this.imageEditter.css({position:"absolute",zIndex:2,top:"50%",left:"50%",marginTop:"-11px",marginLeft:"-18px",lineHeight:1,backgroundColor:"#000",color:"#fff",fontSize:"11px",padding:"7px 10px",cursor:"pointer"});this.imageEditter.attr("contenteditable",
!1);this.imageEditter.on("click",b.proxy(function(){this.imageEdit(a)},this));c.append(this.imageEditter);var d=b('<span id="redactor-image-resizer" data-redactor="verified"></span>');d.css({position:"absolute",zIndex:2,lineHeight:1,cursor:"nw-resize",bottom:"-4px",right:"-5px",border:"1px solid #fff",backgroundColor:"#000",width:"8px",height:"8px"});d.attr("contenteditable",!1);c.append(d);c.append(a);return d},imageThumbClick:function(a){a='<img id="image-marker" src="'+b(a.target).attr("rel")+
'" alt="'+b(a.target).attr("title")+'" />';var c=this.getParent();this.opts.paragraphy&&0==b(c).closest("li").size()&&(a="<p>"+a+"</p>");this.imageInsert(a,!0)},imageCallbackLink:function(){var a=b("#redactor_file_link").val();""!==a?(a='<img id="image-marker" src="'+a+'" />',!1===this.opts.linebreaks&&(a="<p>"+a+"</p>"),this.imageInsert(a,!0)):this.modalClose()},imageCallback:function(a){this.imageInsert(a)},imageInsert:function(a,c){this.selectionRestore();if(!1!==a){var d="";if(!0!==c){var d='<img id="image-marker" src="'+
a.filelink+'" />',e=this.getParent();this.opts.paragraphy&&0==b(e).closest("li").size()&&(d="<p>"+d+"</p>")}else d=a;this.execCommand("inserthtml",d,!1);d=b(this.$editor.find("img#image-marker"));d.length?d.removeAttr("id"):d=!1;this.sync();!0!==c&&this.callback("imageUpload",d,a)}this.modalClose();this.observeImages()},modalTemplatesInit:function(){b.extend(this.opts,{modal_file:String()+'<section><div id="redactor-progress" class="redactor-progress redactor-progress-striped" style="display: none;"><div id="redactor-progress-bar" class="redactor-progress-bar" style="width: 100%;"></div></div><form id="redactorUploadFileForm" method="post" action="" enctype="multipart/form-data"><label>'+
this.opts.curLang.filename+'</label><input type="text" id="redactor_filename" class="redactor_input" /><div style="margin-top: 7px;"><input type="file" id="redactor_file" name="'+this.opts.fileUploadParam+'" /></div></form></section>',modal_image_edit:String()+"<section><label>"+this.opts.curLang.title+'</label><input id="redactor_file_alt" class="redactor_input" /><label>'+this.opts.curLang.link+'</label><input id="redactor_file_link" class="redactor_input" /><label><input type="checkbox" id="redactor_link_blank"> '+
this.opts.curLang.link_new_tab+"</label><label>"+this.opts.curLang.image_position+'</label><select id="redactor_form_image_align"><option value="none">'+this.opts.curLang.none+'</option><option value="left">'+this.opts.curLang.left+'</option><option value="right">'+this.opts.curLang.right+'</option></select></section><footer><button id="redactor_image_delete_btn" class="redactor_modal_btn redactor_modal_delete_btn">'+this.opts.curLang._delete+'</button>&nbsp;&nbsp;&nbsp;<button class="redactor_modal_btn redactor_btn_modal_close">'+
this.opts.curLang.cancel+'</button><input type="button" name="save" class="redactor_modal_btn redactor_modal_action_btn" id="redactorSaveBtn" value="'+this.opts.curLang.save+'" /></footer>',modal_image:String()+'<section><div id="redactor_tabs"><a href="#" class="redactor_tabs_act">'+this.opts.curLang.upload+'</a><a href="#">'+this.opts.curLang.choose+'</a><a href="#">'+this.opts.curLang.link+'</a></div><div id="redactor-progress" class="redactor-progress redactor-progress-striped" style="display: none;"><div id="redactor-progress-bar" class="redactor-progress-bar" style="width: 100%;"></div></div><form id="redactorInsertImageForm" method="post" action="" enctype="multipart/form-data"><div id="redactor_tab1" class="redactor_tab"><input type="file" id="redactor_file" name="'+
this.opts.imageUploadParam+'" /></div><div id="redactor_tab2" class="redactor_tab" style="display: none;"><div id="redactor_image_box"></div></div></form><div id="redactor_tab3" class="redactor_tab" style="display: none;"><label>'+this.opts.curLang.image_web_link+'</label><input type="text" name="redactor_file_link" id="redactor_file_link" class="redactor_input"  /></div></section><footer><button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button><input type="button" name="upload" class="redactor_modal_btn redactor_modal_action_btn" id="redactor_upload_btn" value="'+
this.opts.curLang.insert+'" /></footer>',modal_link:String()+'<section><form id="redactorInsertLinkForm" method="post" action=""><div id="redactor_tabs"><a href="#" class="redactor_tabs_act">URL</a><a href="#">Email</a><a href="#">'+this.opts.curLang.anchor+'</a></div><input type="hidden" id="redactor_tab_selected" value="1" /><div class="redactor_tab" id="redactor_tab1"><label>URL</label><input type="text" id="redactor_link_url" class="redactor_input"  /><label>'+this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_url_text" /><label><input type="checkbox" id="redactor_link_blank"> '+
this.opts.curLang.link_new_tab+'</label></div><div class="redactor_tab" id="redactor_tab2" style="display: none;"><label>Email</label><input type="text" id="redactor_link_mailto" class="redactor_input" /><label>'+this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_mailto_text" /></div><div class="redactor_tab" id="redactor_tab3" style="display: none;"><label>'+this.opts.curLang.anchor+'</label><input type="text" class="redactor_input" id="redactor_link_anchor"  /><label>'+
this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_anchor_text" /></div></form></section><footer><button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button><input type="button" class="redactor_modal_btn redactor_modal_action_btn" id="redactor_insert_link_btn" value="'+this.opts.curLang.insert+'" /></footer>',modal_table:String()+"<section><label>"+this.opts.curLang.rows+'</label><input type="text" size="5" value="2" id="redactor_table_rows" /><label>'+
this.opts.curLang.columns+'</label><input type="text" size="5" value="3" id="redactor_table_columns" /></section><footer><button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button><input type="button" name="upload" class="redactor_modal_btn redactor_modal_action_btn" id="redactor_insert_table_btn" value="'+this.opts.curLang.insert+'" /></footer>',modal_video:String()+'<section><form id="redactorInsertVideoForm"><label>'+this.opts.curLang.video_html_code+'</label><textarea id="redactor_insert_video_area" style="width: 99%; height: 160px;"></textarea></form></section><footer><button class="redactor_modal_btn redactor_btn_modal_close">'+
this.opts.curLang.cancel+'</button><input type="button" class="redactor_modal_btn redactor_modal_action_btn" id="redactor_insert_video_btn" value="'+this.opts.curLang.insert+'" /></footer>'})},modalInit:function(a,c,d,e){var f=b("#redactor_modal_overlay");f.length||(this.$overlay=f=b('<div id="redactor_modal_overlay" style="display: none;"></div>'),b("body").prepend(this.$overlay));if(this.opts.modalOverlay)f.show().on("click",b.proxy(this.modalClose,this));var g=b("#redactor_modal");g.length||(this.$modal=
g=b('<div id="redactor_modal" style="display: none;"><div id="redactor_modal_close">&times;</div><header id="redactor_modal_header"></header><div id="redactor_modal_inner"></div></div>'),b("body").append(this.$modal));b("#redactor_modal_close").on("click",b.proxy(this.modalClose,this));this.hdlModalClose=b.proxy(function(a){if(a.keyCode===this.keyCode.ESC)return this.modalClose(),!1},this);b(document).keyup(this.hdlModalClose);this.$editor.keyup(this.hdlModalClose);this.modalcontent=!1;0==c.indexOf("#")?
(this.modalcontent=b(c),b("#redactor_modal_inner").empty().append(this.modalcontent.html()),this.modalcontent.html("")):b("#redactor_modal_inner").empty().append(c);g.find("#redactor_modal_header").html(a);"undefined"!==typeof b.fn.draggable&&(g.draggable({handle:"#redactor_modal_header"}),g.find("#redactor_modal_header").css("cursor","move"));var h=b("#redactor_tabs");if(h.length){var l=this;h.find("a").each(function(a,c){a++;b(c).on("click",function(c){c.preventDefault();h.find("a").removeClass("redactor_tabs_act");
b(this).addClass("redactor_tabs_act");b(".redactor_tab").hide();b("#redactor_tab"+a).show();b("#redactor_tab_selected").val(a);!1===l.isMobile()&&(c=g.outerHeight(),g.css("margin-top","-"+(c+10)/2+"px"))})})}g.find(".redactor_btn_modal_close").on("click",b.proxy(this.modalClose,this));this.saveModalScroll=!0===this.opts.autoresize?this.document.body.scrollTop:this.$editor.scrollTop();!1===this.isMobile()?(g.css({position:"fixed",top:"-2000px",left:"50%",width:d+"px",marginLeft:"-"+(d+60)/2+"px"}).show(),
this.modalSaveBodyOveflow=b(document.body).css("overflow"),b(document.body).css("overflow","hidden")):g.css({position:"fixed",width:"100%",height:"100%",top:"0",left:"0",margin:"0",minHeight:"300px"}).show();"function"===typeof e&&e();!1===this.isMobile()&&setTimeout(function(){var a=g.outerHeight();g.css({top:"50%",height:"auto",minHeight:"auto",marginTop:"-"+(a+10)/2+"px"})},10)},modalClose:function(){b("#redactor_modal_close").off("click",this.modalClose);b("#redactor_modal").fadeOut("fast",b.proxy(function(){var a=
b("#redactor_modal_inner");!1!==this.modalcontent&&(this.modalcontent.html(a.html()),this.modalcontent=!1);a.html("");this.opts.modalOverlay&&b("#redactor_modal_overlay").hide().off("click",this.modalClose);b(document).unbind("keyup",this.hdlModalClose);this.$editor.unbind("keyup",this.hdlModalClose);this.selectionRestore();this.opts.autoresize&&this.saveModalScroll?b(this.document.body).scrollTop(this.saveModalScroll):!1===this.opts.autoresize&&this.saveModalScroll&&this.$editor.scrollTop(this.saveModalScroll)},
this));!1===this.isMobile()&&b(document.body).css("overflow",this.modalSaveBodyOveflow?this.modalSaveBodyOveflow:"visible");return!1},modalSetTab:function(a){b(".redactor_tab").hide();b("#redactor_tabs").find("a").removeClass("redactor_tabs_act").eq(a-1).addClass("redactor_tabs_act");b("#redactor_tab"+a).show()},s3handleFileSelect:function(a){a=a.target.files;for(var b=0,d;d=a[b];b++)this.s3uploadFile(d)},s3uploadFile:function(a){this.s3executeOnSignedUrl(a,b.proxy(function(b){this.s3uploadToS3(a,
b)},this))},s3executeOnSignedUrl:function(a,c){var d=new XMLHttpRequest,e="?";"-1"!=this.opts.s3.search(/\?/)&&(e="&");d.open("GET",this.opts.s3+e+"name="+a.name+"&type="+a.type,!0);d.overrideMimeType("text/plain; charset=x-user-defined");d.onreadystatechange=function(a){4==this.readyState&&200==this.status&&(b("#redactor-progress").fadeIn(),c(decodeURIComponent(this.responseText)))};d.send()},s3createCORSRequest:function(a,b){var d=new XMLHttpRequest;"withCredentials"in d?d.open(a,b,!0):"undefined"!=
typeof XDomainRequest?(d=new XDomainRequest,d.open(a,b)):d=null;return d},s3uploadToS3:function(a,c){var d=this.s3createCORSRequest("PUT",c);d&&(d.onload=b.proxy(function(){if(200==d.status){b("#redactor-progress, #redactor-progress-drag").hide();var a=c.split("?");if(!a[0])return!1;this.selectionRestore();var f="",f='<img id="image-marker" src="'+a[0]+'" />';this.opts.paragraphy&&(f="<p>"+f+"</p>");this.execCommand("inserthtml",f,!1);a=b(this.$editor.find("img#image-marker"));a.length?a.removeAttr("id"):
a=!1;this.sync();this.callback("imageUpload",a,!1);this.modalClose();this.observeImages()}},this),d.onerror=function(){},d.upload.onprogress=function(a){},d.setRequestHeader("Content-Type",a.type),d.setRequestHeader("x-amz-acl","public-read"),d.send(a))},uploadInit:function(a,c){this.uploadOptions={url:!1,success:!1,error:!1,start:!1,trigger:!1,auto:!1,input:!1};b.extend(this.uploadOptions,c);var d=b("#"+a);d.length&&"INPUT"===d[0].tagName?(this.uploadOptions.input=d,this.el=b(d[0].form)):this.el=
d;this.element_action=this.el.attr("action");this.uploadOptions.auto?b(this.uploadOptions.input).change(b.proxy(function(a){this.el.submit(function(a){return!1});this.uploadSubmit(a)},this)):this.uploadOptions.trigger&&b("#"+this.uploadOptions.trigger).click(b.proxy(this.uploadSubmit,this))},uploadSubmit:function(a){b("#redactor-progress").fadeIn();this.uploadForm(this.element,this.uploadFrame())},uploadFrame:function(){this.id="f"+Math.floor(99999*Math.random());var a=this.document.createElement("div");
a.innerHTML='<iframe style="display:none" id="'+this.id+'" name="'+this.id+'"></iframe>';b(a).appendTo("body");this.uploadOptions.start&&this.uploadOptions.start();b("#"+this.id).load(b.proxy(this.uploadLoaded,this));return this.id},uploadForm:function(a,c){if(this.uploadOptions.input){var d="redactorUploadForm"+this.id,e="redactorUploadFile"+this.id;this.form=b('<form  action="'+this.uploadOptions.url+'" method="POST" target="'+c+'" name="'+d+'" id="'+d+'" enctype="multipart/form-data" />');!1!==
this.opts.uploadFields&&"object"===typeof this.opts.uploadFields&&b.each(this.opts.uploadFields,b.proxy(function(a,c){null!=c&&0===c.toString().indexOf("#")&&(c=b(c).val());var d=b("<input/>",{type:"hidden",name:a,value:c});b(this.form).append(d)},this));var d=this.uploadOptions.input,f=b(d).clone();b(d).attr("id",e).before(f).appendTo(this.form);b(this.form).css("position","absolute").css("top","-2000px").css("left","-2000px").appendTo("body");this.form.submit()}else a.attr("target",c).attr("method",
"POST").attr("enctype","multipart/form-data").attr("action",this.uploadOptions.url),this.element.submit()},uploadLoaded:function(){var a=b("#"+this.id)[0],a=a.contentDocument?a.contentDocument:a.contentWindow?a.contentWindow.document:window.frames[this.id].document;this.uploadOptions.success&&(b("#redactor-progress").hide(),"undefined"!==typeof a?(a=a.body.innerHTML.match(/\{(.|\n)*\}/)[0],a=a.replace(/^\[/,""),a=a.replace(/\]$/,""),a=b.parseJSON(a),"undefined"==typeof a.error?this.uploadOptions.success(a):
(this.uploadOptions.error(this,a),this.modalClose())):(this.modalClose(),alert("Upload failed!")));this.el.attr("action",this.element_action);this.el.attr("target","")},draguploadInit:function(a,c){this.draguploadOptions=b.extend({url:!1,success:!1,error:!1,preview:!1,uploadFields:!1,text:this.opts.curLang.drop_file_here,atext:this.opts.curLang.or_choose,uploadParam:!1},c);if(void 0===window.FormData)return!1;this.droparea=b('<div class="redactor_droparea"></div>');this.dropareabox=b('<div class="redactor_dropareabox">'+
this.draguploadOptions.text+"</div>");this.dropalternative=b('<div class="redactor_dropalternative">'+this.draguploadOptions.atext+"</div>");this.droparea.append(this.dropareabox);b(a).before(this.droparea);b(a).before(this.dropalternative);this.dropareabox.on("dragover",b.proxy(function(){return this.draguploadOndrag()},this));this.dropareabox.on("dragleave",b.proxy(function(){return this.draguploadOndragleave()},this));this.dropareabox.get(0).ondrop=b.proxy(function(a){a.preventDefault();this.dropareabox.removeClass("hover").addClass("drop");
this.dragUploadAjax(this.draguploadOptions.url,a.dataTransfer.files[0],!1,!1,!1,this.draguploadOptions.uploadParam)},this)},dragUploadAjax:function(a,c,d,e,f,g){if(!d){var h=b.ajaxSettings.xhr();h.upload&&h.upload.addEventListener("progress",b.proxy(this.uploadProgress,this),!1);b.ajaxSetup({xhr:function(){return h}})}var l=new FormData;!1!==g?l.append(g,c):l.append("file",c);!1!==this.opts.uploadFields&&"object"===typeof this.opts.uploadFields&&b.each(this.opts.uploadFields,b.proxy(function(a,c){null!=
c&&0===c.toString().indexOf("#")&&(c=b(c).val());l.append(a,c)},this));b.ajax({url:a,dataType:"html",data:l,cache:!1,contentType:!1,processData:!1,type:"POST",success:b.proxy(function(a){a=a.replace(/^\[/,"");a=a.replace(/\]$/,"");a="string"===typeof a?b.parseJSON(a):a;if(d){e.fadeOut("slow",function(){b(this).remove()});var c=b("<img>");c.attr("src",a.filelink).attr("id","drag-image-marker");this.insertNodeToCaretPositionFromPoint(f,c[0]);c=b(this.$editor.find("img#drag-image-marker"));c.length?
c.removeAttr("id"):c=!1;this.sync();this.observeImages();c&&this.callback("imageUpload",c,a);"undefined"!==typeof a.error&&this.callback("imageUploadError",a)}else"undefined"==typeof a.error?this.draguploadOptions.success(a):(this.draguploadOptions.error(this,a),this.draguploadOptions.success(!1))},this)})},draguploadOndrag:function(){this.dropareabox.addClass("hover");return!1},draguploadOndragleave:function(){this.dropareabox.removeClass("hover");return!1},uploadProgress:function(a,b){var d=a.loaded?
parseInt(a.loaded/a.total*100,10):a;this.dropareabox.text("Loading "+d+"% "+(b||""))},isMobile:function(){return/(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent)},normalize:function(a){return"undefined"===typeof a?0:parseInt(a.replace("px",""),10)},outerHtml:function(a){return b("<div>").append(b(a).eq(0).clone()).html()},isString:function(a){return"[object String]"==Object.prototype.toString.call(a)},isEmpty:function(a){a=a.replace(/&#x200b;|<br>|<br\/>|&nbsp;/gi,"");a=a.replace(/\s/g,
"");a=a.replace(/^<p>[^\W\w\D\d]*?<\/p>$/i,"");return""==a},browser:function(a){var b=navigator.userAgent.toLowerCase(),b=/(chrome)[ \/]([\w.]+)/.exec(b)||/(webkit)[ \/]([\w.]+)/.exec(b)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(b)||/(msie) ([\w.]+)/.exec(b)||0>b.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(b)||[];return"version"==a?b[2]:"webkit"==a?"chrome"==b[1]||"webkit"==b[1]:b[1]==a},oldIE:function(){return this.browser("msie")&&9>parseInt(this.browser("version"),10)?!0:!1},getFragmentHtml:function(a){a=
a.cloneNode(!0);var b=this.document.createElement("div");b.appendChild(a);return b.innerHTML},extractContent:function(){for(var a=this.$editor[0],b=this.document.createDocumentFragment(),d;d=a.firstChild;)b.appendChild(d);return b},isParentRedactor:function(a){return a?this.opts.iframe?a:0==b(a).parents("div.redactor_editor").length||b(a).hasClass("redactor_editor")?!1:a:!1},currentOrParentIs:function(a){var b=this.getParent(),d=this.getCurrent();return b&&b.tagName===a?b:d&&d.tagName===a?d:!1},isEndOfElement:function(){var a=
this.getBlock(),c=this.getCaretOffset(a),a=b.trim(b(a).text()).replace(/\n\r\n/g,"").length;return c==a?!0:!1},isFocused:function(){var a,c=this.getSelection();c&&c.rangeCount&&0<c.rangeCount&&(a=c.getRangeAt(0).startContainer);return a?this.opts.iframe?this.getCaretOffsetRange().equals()?!this.$editor.is(a):!0:0!=b(a).closest("div.redactor_editor").length:!1},removeEmptyAttr:function(a,c){""==b(a).attr(c)&&b(a).removeAttr(c)},removeFromArrayByValue:function(a,b){for(var d=null;-1!==(d=a.indexOf(b));)a.splice(d,
1);return a}};q.prototype.init.prototype=q.prototype;b.Redactor.fn.formatLinkify=function(a,c,d,e,f){for(var g=/(^|&lt;|\s)(www\..+?\..+?)(\s|&gt;|$)/g,h=/(^|&lt;|\s)(((https?|ftp):\/\/|mailto:).+?)(\s|&gt;|$)/g,l=/(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/gi,m=/https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube\.com\S*[^\w\-\s])([\w\-]{11})(?=[^\w\-]|$)(?![?=&+%\w.-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/ig,p=/https?:\/\/(www\.)?vimeo.com\/(\d+)($|\/)/,q=(this.$editor?this.$editor.get(0):this).childNodes,
t=q.length;t--;){var r=q[t];if(3===r.nodeType){var n=r.nodeValue;e&&n&&(n.match(m)?(n=n.replace(m,'<iframe width="500" height="281" src="//www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe>'),b(r).after(n).remove()):n.match(p)&&(n=n.replace(p,'<iframe width="500" height="281" src="//player.vimeo.com/video/$2" frameborder="0" allowfullscreen></iframe>'),b(r).after(n).remove()));d&&n&&n.match(l)&&(n=n.replace(l,'<img src="$1">'),b(r).after(n).remove());if(c&&n&&(n.match(g)||n.match(h))){var s=
n.match(g)||n.match(h),s=s[0];s.length>f&&(s=s.substring(0,f)+"...");n=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(g,'$1<a href="'+a+'$2">'+b.trim(s)+"</a>$3").replace(h,'$1<a href="$2">'+b.trim(s)+"</a>$5");b(r).after(n).remove()}}else 1!==r.nodeType||/^(a|button|textarea)$/i.test(r.tagName)||b.Redactor.fn.formatLinkify.call(r,a,c,d,e,f)}}})(jQuery);